<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Story ğŸ’– Asep & Udel</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ec4899">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Quicksand', 'sans-serif'] },
                    colors: { dark: { bg: '#1a1a2e', card: '#16213e', text: '#e94560' } }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        
        body { -webkit-tap-highlight-color: transparent; font-family: 'Quicksand', sans-serif; }
        
        /* Animasi */
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .float-anim { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        
        .float-anim-delay { 
            animation: float 6s ease-in-out infinite; 
            animation-delay: 2s; /* Jeda 2 detik agar gerakannya gantian */
        }

        .heartbeat { animation: heartbeat 1.5s infinite; }
        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .animate-spin-slow { animation: spin 4s linear infinite; } 
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Utilitas */
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #map { z-index: 10; border-radius: 1.5rem; height: 100%; width: 100%; }
        
        /* Nav Active State */
        .nav-active span { transform: scale(1.2); display: inline-block; transition: transform 0.2s; }
        .nav-active { color: #ec4899; font-weight: bold; }
        .dark .nav-active { color: #f472b6; }

        /* TAB LOGIC */
        .tab-content { display: none; width: 100%; }
        .tab-content.active { display: block; animation: scaleIn 0.3s ease-out; }

        /* --- PERBAIKAN LAYOUT MOBILE --- */
        .header-mobile-fix {
            top: 0;
            padding-top: max(0.5rem, env(safe-area-inset-top));
            height: auto;
            min-height: 3.5rem;
            align-items: center;
        }

        #header-profil {
            padding-top: calc(5rem + env(safe-area-inset-top)); 
            padding-bottom: 2rem;
        }

        /* Update Navigasi Mobile agar muat 6 tombol */
        nav.fixed.bottom-0 {
            padding-bottom: max(1rem, env(safe-area-inset-bottom));
            height: auto;
            min-height: 4.5rem;
        }

        @media (max-width: 768px) {
            nav.md\:hidden .flex {
                justify-content: space-around;
                padding-left: 0.2rem;
                padding-right: 0.2rem;
            }
            nav.md\:hidden button {
                width: 16%; 
                font-size: 8px; /* Ukuran teks lebih kecil agar tidak tabrakan */
            }
            /* Perbaikan Tombol Diary Mobile */
            #diary .flex-col-mobile {
                flex-direction: column !important;
            }
            #diary .flex-col-mobile button {
                width: 100%;
                margin-top: 0.5rem;
            }
        }

        /* MARKER MAPS */
        .cute-marker { background: transparent; border: none; }
        .cute-pin-body {
            width: 40px; height: 40px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 3px solid white;
            animation: bouncePin 1s infinite alternate;
        }
        .cute-pin-body > span { transform: rotate(45deg); font-size: 20px; }
        .pin-p1 { background: linear-gradient(135deg, #3b82f6, #2563eb); } 
        .pin-p2 { background: linear-gradient(135deg, #ec4899, #db2777); } 

        @keyframes bouncePin {
            0% { transform: rotate(-45deg) translateY(0); }
            100% { transform: rotate(-45deg) translateY(-5px); }
        }

        .location-card { transition: all 0.3s ease; }
        .location-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        /* Gaya Status Bar Game */
        .stats-container {
            width: 100%;
            max-width: 200px;
            margin-top: 1rem;
        }
        .stat-row {
            margin-bottom: 0.5rem;
        }
        .stat-label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .stat-bar-bg {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .stat-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
        /* Warna bar berdasarkan level */
        .bar-low { background: #f87171; }
        .bar-mid { background: #fbbf24; }
        .bar-high { background: #34d399; }

        .stat-controls {
            display: flex;
            gap: 5px;
            margin-top: 2px;
            justify-content: flex-end;
        }
        .btn-stat {
            font-size: 10px;
            padding: 0 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
        }
        .dark .stat-bar-bg { background: #334155; }
        .dark .btn-stat { background: #1e293b; border-color: #475569; color: white; }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-50 to-white dark:from-slate-900 dark:to-slate-800 text-gray-700 dark:text-gray-200 overflow-x-hidden pb-24 transition-colors duration-500" id="bodyContent">

    <div id="welcomeScreen" class="fixed inset-0 z-[300] bg-gradient-to-br from-pink-100 to-purple-100 dark:from-slate-900 dark:to-purple-900 flex flex-col items-center justify-center text-center p-6 transition duration-1000">
        <div class="relative w-32 h-32 mb-6">
            <div class="absolute inset-0 bg-pink-400 rounded-full animate-ping opacity-20"></div>
            <div class="relative bg-white dark:bg-slate-800 p-2 rounded-full shadow-xl">
                <span class="text-6xl">ğŸ’Œ</span>
            </div>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">Our Love App</h1>
        <p class="text-gray-500 dark:text-gray-300 mb-8 text-sm">Siapa yang mau masuk?</p>
        
        <div class="flex gap-4">
            <button onclick="selectUser('p1')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg transform active:scale-95 transition flex flex-col items-center">
                <span class="text-2xl mb-1">ğŸ¤´</span> Asep
            </button>
            <button onclick="selectUser('p2')" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg transform active:scale-95 transition flex flex-col items-center">
                <span class="text-2xl mb-1">ğŸ‘¸</span> Udel
            </button>
        </div>
    </div>

    <audio id="bgAudio" loop>
        <source src="Yung Kai - Blue.mp3" type="audio/mpeg">
    </audio>

    <div class="md:hidden fixed left-0 w-full bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-b border-pink-100 dark:border-slate-800 z-40 flex items-center justify-center shadow-sm header-mobile-fix">
        <div class="text-lg font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-600 tracking-widest">OUR STORY ğŸ’–</div>
    </div>

    <button onclick="toggleSettings()" class="md:hidden fixed top-5 left-5 z-50 text-gray-500 dark:text-gray-300 hover:text-pink-500 transition-colors duration-300 transform active:scale-90">
        <i class="fas fa-bars text-3xl drop-shadow-sm"></i>
    </button>

    <div class="fixed bottom-24 right-4 z-[50] md:bottom-10 md:right-10" style="bottom: calc(5.5rem + env(safe-area-inset-bottom));">
        <button onclick="toggleMusic()" id="musicBtn" class="glass p-4 rounded-full shadow-[0_4px_15px_rgba(236,72,153,0.3)] active:scale-90 transition-all bg-white/90 dark:bg-slate-800/90 border-2 border-pink-200 dark:border-pink-500/30 group">
            <div id="musicIcon" class="animate-spin-slow text-xl md:text-2xl">ğŸµ</div>
            
            <span class="absolute right-16 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap hidden md:block">
                Mute/Play Music
            </span>
        </button>
    </div>

    <button onclick="showIdentityPopup()" class="fixed bottom-20 left-4 z-[50] glass p-3 rounded-full shadow-[0_0_15px_rgba(236,72,153,0.5)] heartbeat group transition hover:scale-110 active:scale-90 bg-white dark:bg-slate-800" style="bottom: calc(5rem + env(safe-area-inset-bottom));">
        <span class="text-3xl">ğŸ’–</span>
    </button>

    <div id="customInputPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[400] flex items-center justify-center hidden opacity-0 transition-opacity duration-300 px-6">
        <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-6 shadow-2xl w-full max-w-sm scale-in border-4 border-pink-200 dark:border-slate-600">
            <h3 class="text-xl font-bold text-pink-500 mb-2" id="customInputTitle">Judul</h3>
            <input type="text" id="customInputField" class="w-full p-4 bg-gray-50 dark:bg-slate-900 rounded-xl mb-6 focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm dark:text-white" placeholder="...">
            <div class="flex gap-3">
                <button onclick="closeCustomInput()" class="flex-1 bg-gray-100 dark:bg-slate-700 text-gray-500 py-3 rounded-xl font-bold text-sm">Batal</button>
                <button id="customInputConfirmBtn" class="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Simpan</button>
            </div>
        </div>
    </div>

    <div id="pinOverlay" class="hidden fixed inset-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl z-[290] flex flex-col items-center justify-center text-gray-800 dark:text-white transition-all duration-500">
        <div class="text-center p-8 w-full max-w-sm scale-in bg-white dark:bg-slate-800 rounded-3xl shadow-2xl border border-gray-100 dark:border-slate-700">
            <div id="loginAvatar" class="text-6xl mb-4 animate-bounce">ğŸ”’</div>
            <h1 class="text-2xl font-bold mb-1">Login User</h1>
            <p id="loginGreeting" class="mb-6 text-gray-400 text-sm">Masukkan password kamu.</p>
            
            <input type="password" id="userPasswordInput" class="text-center text-2xl text-gray-700 dark:text-white p-4 rounded-xl w-full focus:outline-none bg-gray-100 dark:bg-slate-900 border-2 border-transparent focus:border-pink-300 transition-all mb-4" placeholder="Password">
            
            <button onclick="checkUserPassword()" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white w-full py-4 rounded-xl font-bold shadow-lg transform active:scale-95 transition">MASUK</button>
            <button onclick="cancelLogin()" class="mt-4 text-xs text-gray-400 hover:text-pink-500">Kembali</button>
        </div>
    </div>

    <div id="customPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[250] flex items-center justify-center hidden transition-opacity duration-300 opacity-0 px-6">
        <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-8 shadow-2xl w-full max-w-sm text-center scale-in border-4 border-pink-100 dark:border-slate-700">
            <div id="popupIcon" class="text-6xl mb-4 filter drop-shadow-md">ğŸ‰</div>
            <h3 id="popupTitle" class="text-xl font-bold text-gray-800 dark:text-white mb-2">Title</h3>
            <p id="popupMessage" class="text-gray-500 dark:text-gray-400 text-sm mb-8 leading-relaxed font-medium">Message</p>
            <div id="popupActions" class="flex gap-3 justify-center"></div>
        </div>
    </div>

    <div id="identityPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[260] flex items-center justify-center hidden transition-opacity duration-300 opacity-0 px-6">
        <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] p-8 shadow-2xl w-full max-w-sm text-center scale-in border-4 border-pink-200 dark:border-slate-600 relative">
            <button onclick="closeIdentityPopup()" class="absolute top-5 right-5 text-gray-300 hover:text-red-500 text-xl font-bold">âœ•</button>
            <div class="text-5xl mb-4">ğŸ””</div>
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-1">Kangen Banget?</h3>
            <p class="text-xs text-gray-400 mb-8">Bunyikan notifikasi di HP pasangan kamu!</p>
            <div class="flex flex-col gap-4">
                <button onclick="processMissYou('p1')" class="bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 border-2 border-blue-100 dark:border-blue-800 font-bold py-4 rounded-2xl hover:bg-blue-100 transition active:scale-95 flex items-center justify-center gap-3">
                    <span class="text-2xl">ğŸ¤´</span> Aku <span id="btnNameP1">Cowok</span>
                </button>
                <button onclick="processMissYou('p2')" class="bg-pink-50 dark:bg-pink-900/30 text-pink-600 dark:text-pink-300 border-2 border-pink-100 dark:border-pink-800 font-bold py-4 rounded-2xl hover:bg-pink-100 transition active:scale-95 flex items-center justify-center gap-3">
                    <span class="text-2xl">ğŸ‘¸</span> Aku <span id="btnNameP2">Cewek</span>
                </button>
            </div>
        </div>
    </div>

    <div id="mapInputPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[260] flex items-center justify-center hidden transition-opacity duration-300 opacity-0 px-6">
        <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-8 shadow-2xl w-full max-w-sm text-center scale-in border-4 border-blue-100 dark:border-slate-700">
            <div class="text-5xl mb-4">ğŸ“</div>
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Tandai Lokasi</h3>
            <p class="text-xs text-gray-400 mb-6">Kasih nama tempat kenangan ini.</p>
            <input type="text" id="mapNoteInput" placeholder="Contoh: Tempat Pertama Ketemu" class="w-full p-4 bg-gray-50 dark:bg-slate-900 rounded-xl mb-6 focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm font-bold text-gray-700 dark:text-white text-center border border-gray-200 dark:border-slate-600">
            <div class="flex gap-3">
                <button onclick="closeMapInput()" class="flex-1 bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-400 py-3 rounded-xl font-bold text-sm">Batal</button>
                <button onclick="confirmAddMap()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg active:scale-95">Simpan</button>
            </div>
        </div>
    </div>

    <div id="lightbox" class="fixed inset-0 bg-black/95 z-[400] hidden flex flex-col justify-center items-center transition-opacity duration-300 opacity-0">
        <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white text-4xl font-bold z-50 p-2 hover:text-gray-300 transition">Ã—</button>
        <button onclick="prevImage(event)" class="absolute left-0 top-1/2 transform -translate-y-1/2 text-white text-5xl p-4 hover:text-gray-300 transition z-50 outline-none">â®</button>
        <button onclick="nextImage(event)" class="absolute right-0 top-1/2 transform -translate-y-1/2 text-white text-5xl p-4 hover:text-gray-300 transition z-50 outline-none">â¯</button>
        <img id="lightboxImg" src="" class="max-w-[95%] max-h-[85%] rounded-xl shadow-2xl scale-in object-contain transition-all duration-300">
        <p class="text-white mt-4 text-xs font-bold opacity-70 bg-black/20 px-4 py-2 rounded-full">Geser Kiri / Kanan</p>
    </div>

    <div id="mainApp" class="opacity-0 transition duration-1000 min-h-screen flex flex-col">
        
        <nav class="hidden md:block bg-white/70 dark:bg-slate-900/70 backdrop-blur-md border-b border-pink-100 dark:border-slate-800 sticky top-0 z-40 transition-colors duration-500">
            <div class="max-w-6xl mx-auto px-6 h-20 flex justify-between items-center">
                <div class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-600 tracking-wider">OUR STORY ğŸ’–</div>
                <div class="flex gap-8 text-sm font-bold text-gray-500 dark:text-gray-400">
                    <button onclick="switchTab('header-profil')" class="nav-item hover:text-pink-500 transition nav-active" id="nav-header-profil">Profil</button>
                    <button onclick="switchTab('gallery')" class="nav-item hover:text-pink-500 transition" id="nav-gallery">Memories</button>
                    <button onclick="switchTab('wishlist')" class="nav-item hover:text-pink-500 transition" id="nav-wishlist">Bucket List</button>
                    <button onclick="switchTab('diary')" class="nav-item hover:text-pink-500 transition" id="nav-diary">Diary</button>
                    <button onclick="switchTab('maps')" class="nav-item hover:text-pink-500 transition" id="nav-maps">Maps</button>
                    <button onclick="switchTab('videos')" class="nav-item hover:text-pink-500 transition" id="nav-videos">Vault</button>
                    <button onclick="toggleSettings()" class="text-pink-500 text-lg hover:scale-110 transition">âš™ï¸</button>
                </div>
            </div>
        </nav>

        <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white/95 dark:bg-slate-900/95 backdrop-blur-lg border-t border-pink-100 dark:border-slate-800 z-[45] pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
            <div class="flex justify-between items-center h-16 px-1 text-[9px] font-bold text-gray-400">
                <button onclick="switchTab('header-profil')" class="nav-item flex flex-col items-center gap-1 active:scale-95 transition-all nav-active" id="mob-nav-header-profil"><span class="text-xl">ğŸ‘¤</span>Profil</button>
                <button onclick="switchTab('gallery')" class="nav-item flex flex-col items-center gap-1 active:scale-95 transition-all" id="mob-nav-gallery"><span class="text-xl">ğŸ“¸</span>Memo</button>
                <button onclick="switchTab('wishlist')" class="nav-item flex flex-col items-center gap-1 active:scale-95 transition-all" id="mob-nav-wishlist"><span class="text-xl">âœˆï¸</span>List</button>
                <button onclick="switchTab('diary')" class="nav-item flex flex-col items-center gap-1 active:scale-95 transition-all" id="mob-nav-diary"><span class="text-xl">ğŸ“–</span>Diary</button>
                <button onclick="switchTab('maps')" class="nav-item flex flex-col items-center gap-1 active:scale-95 transition-all" id="mob-nav-maps"><span class="text-xl">ğŸ—ºï¸</span>Maps</button>
                <button onclick="switchTab('videos')" class="nav-item flex flex-col items-center gap-1 active:scale-95 transition-all" id="mob-nav-videos"><span class="text-xl">ğŸ”—</span>Vault</button>
            </div>
        </nav>

        <div id="extraMenu" class="hidden fixed bottom-20 right-4 z-[46] bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-pink-100 dark:border-slate-700 p-2 flex flex-col gap-2 scale-in">
            <button onclick="switchTab('maps'); toggleExtraMenu()" class="flex items-center gap-3 px-4 py-2 text-sm font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl"><span class="text-xl">ğŸ—ºï¸</span> Maps</button>
            <button onclick="switchTab('videos'); toggleExtraMenu()" class="flex items-center gap-3 px-4 py-2 text-sm font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl"><span class="text-xl">ğŸ”—</span> Vault</button>
            <button onclick="toggleSettings(); toggleExtraMenu()" class="flex items-center gap-3 px-4 py-2 text-sm font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl"><span class="text-xl">âš™ï¸</span> Setting</button>
        </div>

        <div id="settingsPanel" class="hidden fixed top-0 left-0 h-screen w-full md:w-80 bg-white/95 dark:bg-slate-800/95 backdrop-blur-xl p-6 shadow-2xl z-[100] border-r border-pink-100 dark:border-slate-700 fade-in overflow-y-auto text-gray-700 dark:text-gray-200">
            <div class="flex justify-between items-center mb-8 border-b dark:border-slate-600 pb-4">
                <h3 class="font-bold text-xl">âš™ï¸ Pengaturan</h3>
                <button onclick="toggleSettings()" class="w-10 h-10 bg-red-100 dark:bg-slate-700 rounded-full flex items-center justify-center text-red-500 font-bold transition-all active:scale-95">âœ•</button>
            </div>
            
            <div class="space-y-6">
                <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-2xl border border-green-100 dark:border-green-800">
                    <label class="block text-[10px] text-green-600 dark:text-green-300 font-bold mb-2 uppercase tracking-wider">Ganti Lagu (Lokal)</label>
                    <input type="file" id="localMusicInput" accept="audio/*" onchange="changeLocalMusic(this)" class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    <button onclick="resetLocalMusic()" class="mt-2 text-[10px] text-red-500 font-bold underline transition-all active:scale-95">Reset ke Lagu Awal</button>
                </div>

                <div class="bg-indigo-50 dark:bg-indigo-900/30 p-4 rounded-2xl border border-indigo-100 dark:border-indigo-800">
                    <label class="block text-[10px] text-indigo-500 dark:text-indigo-300 font-bold mb-3 uppercase tracking-wider">Identitas & Kontak</label>
                    <div class="mb-3">
                        <label class="text-[10px] font-bold opacity-70">ğŸ‘¤ Pihak 1 (Cowok)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="nameP1Input" placeholder="Nama" class="w-1/3 p-2 rounded-lg text-xs bg-white dark:bg-slate-800 border dark:border-slate-600 focus:outline-none">
                            <input type="text" id="waP1Input" placeholder="628xxx" class="w-2/3 p-2 rounded-lg text-xs bg-white dark:bg-slate-800 border dark:border-slate-600 focus:outline-none">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="text-[10px] font-bold opacity-70">ğŸ‘¤ Pihak 2 (Cewek)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="nameP2Input" placeholder="Nama" class="w-1/3 p-2 rounded-lg text-xs bg-white dark:bg-slate-800 border dark:border-slate-600 focus:outline-none">
                            <input type="text" id="waP2Input" placeholder="628xxx" class="w-2/3 p-2 rounded-lg text-xs bg-white dark:bg-slate-800 border dark:border-slate-600 focus:outline-none">
                        </div>
                    </div>
                    <button onclick="updateContacts()" class="w-full bg-indigo-500 text-white text-xs font-bold py-2.5 rounded-xl shadow hover:bg-indigo-600 active:scale-95 transition">Simpan Identitas</button>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wider">Keamanan</label>
                    <div class="flex gap-2">
                        <input type="text" id="newPinInput" placeholder="PIN Baru" class="flex-1 p-3 bg-gray-50 dark:bg-slate-700 rounded-xl text-sm border border-gray-100 dark:border-slate-600 focus:outline-none">
                        <button onclick="updatePin()" class="bg-gray-800 dark:bg-slate-600 text-white text-xs font-bold px-4 rounded-xl transition-all active:scale-95">Ganti</button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wider">Tanggal Jadian</label>
                    <div class="flex gap-2 mb-2">
                        <input type="date" id="startDateInput" class="w-3/5 p-2 bg-gray-50 dark:bg-slate-700 rounded-xl text-sm border border-gray-100 dark:border-slate-600 dark:text-white">
                        <input type="time" id="startTimeInput" class="w-2/5 p-2 bg-gray-50 dark:bg-slate-700 rounded-xl text-sm border border-gray-100 dark:border-slate-600 dark:text-white">
                    </div>
                    <button onclick="updateDate()" class="w-full bg-pink-500 text-white text-xs font-bold py-2.5 rounded-xl shadow hover:bg-pink-600 active:scale-95 transition">Update Tanggal</button>
                </div>

                <div class="flex justify-between items-center bg-gray-100 dark:bg-slate-700 p-4 rounded-xl">
                    <span class="font-bold text-sm">Mode Gelap</span>
                    <button onclick="toggleDarkMode()" class="w-10 h-10 bg-white dark:bg-slate-600 rounded-full flex items-center justify-center text-xl transition shadow active:scale-95">ğŸŒ“</button>
                </div>
            </div>
        </div>

        <header id="header-profil" class="relative overflow-hidden tab-content active">
            <div class="absolute top-0 left-0 w-64 h-64 bg-pink-200 dark:bg-slate-700 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
            <div class="absolute top-0 right-0 w-64 h-64 bg-purple-200 dark:bg-slate-800 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
            
            <div class="max-w-7xl mx-auto relative z-10 px-4">
                <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-8 md:gap-4 text-center">
                    <div class="order-1 flex flex-col items-center">
                        <div class="relative w-40 h-40 md:w-56 md:h-56 mb-4 group cursor-pointer float-anim" onclick="document.getElementById('uploadP1').click()">
                            <img id="imgP1" src="https://via.placeholder.com/200?text=Cowok" class="w-full h-full object-cover rounded-full border-[6px] border-white dark:border-slate-800 shadow-xl relative z-10">
                            <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-full opacity-0 group-hover:opacity-100 transition z-20 text-white text-xs font-bold backdrop-blur-[2px]">ğŸ“· GANTI</div>
                        </div>
                        <input type="file" id="uploadP1" class="hidden" accept="image/*" onchange="changeProfilePic(this, 'p1')">
                        <h2 id="nameP1" contenteditable="true" onblur="saveProfileText('p1', 'name', 'nameP1')" class="text-2xl font-bold text-gray-800 dark:text-white px-3 rounded-lg focus:bg-white dark:focus:bg-slate-800 outline-none">Asep</h2>
                        <p id="statusP1" contenteditable="true" onblur="saveProfileText('p1', 'status', 'statusP1')" class="text-sm font-medium text-gray-500 dark:text-gray-400 mt-1 italic px-2 focus:bg-white dark:focus:bg-slate-800 outline-none">The King ğŸ‘‘</p>
                        <div class="stats-container mx-auto" id="statsP1">
                            </div>
                        <button onclick="addNewStat('p1')" class="text-[9px] mt-2 font-bold text-blue-500 opacity-50 hover:opacity-100">+ Tambah Sifat</button>
                    </div>

                    <div class="order-3 md:order-2 flex flex-col items-center justify-center">
                        <h2 class="text-xl font-bold text-pink-500 uppercase tracking-[0.3em] mb-4">Together Since</h2>
                        <div id="startDateDisplay" class="text-sm font-bold text-gray-400 dark:text-gray-500 mb-8 bg-white/60 dark:bg-slate-800/60 px-4 py-1 rounded-full shadow-sm">...</div>
                        <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md p-6 rounded-[2rem] shadow-2xl border-2 border-white dark:border-slate-700 w-full max-w-sm mx-auto transform hover:scale-105 transition duration-500 cursor-help" onclick="toggleSettings()">
                            <div id="loveTimer" class="grid grid-cols-2 gap-4 font-mono text-gray-700 dark:text-gray-300"></div>
                        </div>
                    </div>

                    <div class="order-2 md:order-3 flex flex-col items-center">
                        <div class="relative w-40 h-40 md:w-56 md:h-56 mb-4 group cursor-pointer float-anim-delay" onclick="document.getElementById('uploadP2').click()">
                            <img id="imgP2" src="https://via.placeholder.com/200?text=Cewek" class="w-full h-full object-cover rounded-full border-[6px] border-white dark:border-slate-800 shadow-xl relative z-10">
                            <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-full opacity-0 group-hover:opacity-100 transition z-20 text-white text-xs font-bold backdrop-blur-[2px]">ğŸ“· GANTI</div>
                        </div>
                        <input type="file" id="uploadP2" class="hidden" accept="image/*" onchange="changeProfilePic(this, 'p2')">
                        <h2 id="nameP2" contenteditable="true" onblur="saveProfileText('p2', 'name', 'nameP2')" class="text-2xl font-bold text-gray-800 dark:text-white px-3 rounded-lg focus:bg-white dark:focus:bg-slate-800 outline-none">Udel</h2>
                        <p id="statusP2" contenteditable="true" onblur="saveProfileText('p2', 'status', 'statusP2')" class="text-sm font-medium text-gray-500 dark:text-gray-400 mt-1 italic px-2 focus:bg-white dark:focus:bg-slate-800 outline-none">The Queen ğŸ‘‘</p>
                        <div class="stats-container mx-auto" id="statsP2">
                            </div>
                        <button onclick="addNewStat('p2')" class="text-[9px] mt-2 font-bold text-pink-500 opacity-50 hover:opacity-100">+ Tambah Sifat</button>
                    </div>
                </div>
            </div>
        </header>
        
        <section id="gallery" class="py-20 px-4 max-w-7xl mx-auto w-full tab-content">
            <div class="flex flex-col md:flex-row items-center justify-between mb-12 gap-6">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Our Memories ğŸ“¸</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Simpan setiap momen manis kita di sini.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleSelectionMode()" id="btnSelectMode" class="bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 font-bold px-6 py-3 rounded-full shadow-md active:scale-95 transition">âœ“ Pilih</button>
                    <button onclick="deleteSelectedMemories()" id="btnDeleteSelected" class="hidden bg-red-500 text-white font-bold px-6 py-3 rounded-full shadow-md active:scale-95 transition">ğŸ—‘ï¸ Hapus (<span id="selectedCount">0</span>)</button>
                    <label class="bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white font-bold px-8 py-3 rounded-full shadow-lg shadow-pink-200 dark:shadow-none cursor-pointer flex items-center gap-2 transition transform hover:-translate-y-1 active:scale-95">
                        <span>+ Upload</span>
                        <input type="file" class="hidden" multiple accept="image/*" onchange="window.addPhotos(this)">
                    </label>
                </div>
            </div>
            <div id="photoGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
            <div id="emptyMsg" class="hidden text-center text-gray-400 dark:text-gray-500 mt-4 py-20 bg-white/50 dark:bg-slate-800/50 rounded-3xl border-2 border-dashed border-pink-200 dark:border-slate-700 flex flex-col items-center justify-center">
                <span class="text-5xl mb-4 opacity-50">ğŸ“·</span>
                <p>Belum ada foto. Yuk upload momen pertamamu!</p>
            </div>
        </section>

        <section id="wishlist" class="py-20 px-4 bg-pink-50 dark:bg-slate-900 border-t border-pink-100 dark:border-slate-800 transition-colors duration-500 rounded-t-[3rem] mt-10 tab-content">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">Bucket List âœˆï¸</h2>
                    <p class="text-gray-500 dark:text-gray-400">Mimpi-mimpi kita yang harus diwujudkan.</p>
                </div>
                <div class="w-full max-w-xl mx-auto bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-lg border border-pink-100 dark:border-slate-700 mb-8">
                    <div class="flex flex-col gap-2">
                        <input type="text" id="wishName" placeholder="Rencana baru..." class="w-full p-3 bg-gray-50 dark:bg-slate-900 rounded-xl text-sm outline-none font-bold">
                        <div class="flex gap-2">
                            <input type="number" id="wishCost" placeholder="Rp 0" class="w-1/3 p-2 bg-gray-50 dark:bg-slate-900 rounded-lg text-xs outline-none">
                            <input type="url" id="wishLink" placeholder="Link (Opsional)" class="w-1/3 p-2 bg-gray-50 dark:bg-slate-900 rounded-lg text-xs outline-none">
                            <button onclick="pickMapLocationForWish()" class="w-1/3 bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300 rounded-lg text-xs font-bold hover:bg-blue-200 transition flex items-center justify-center gap-1">
                                ğŸ“ <span id="locStatus">Pilih Lokasi</span>
                            </button>
                        </div>
                    </div>
                    <button onclick="window.addWish()" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 rounded-xl shadow-lg mt-3 transition transform active:scale-95">â• Tambah Ke List</button>
                </div>
                <div class="md:col-span-2">
                    <div class="flex gap-4 mb-6 text-sm font-bold overflow-x-auto pb-2 no-scrollbar">
                        <span class="bg-white dark:bg-slate-800 px-5 py-2.5 rounded-full shadow-sm border border-pink-100 dark:border-slate-700 text-pink-600 dark:text-pink-400 flex items-center gap-2 whitespace-nowrap">ğŸ¯ Total: <span id="totalWishes">0</span></span>
                        <span class="bg-white dark:bg-slate-800 px-5 py-2.5 rounded-full shadow-sm border border-green-100 dark:border-slate-700 text-green-600 dark:text-green-400 flex items-center gap-2 whitespace-nowrap">âœ… Sudah: <span id="completedWishes">0</span></span>
                    </div>
                    <div id="wishlistGrid" class="flex flex-col gap-4"></div>
                    <div id="noWishMsg" class="hidden text-center text-gray-400 dark:text-gray-500 py-20"><span class="text-4xl">ğŸ—ºï¸</span><br>Belum ada rencana.</div>
                </div>
            </div>
        </section>

        <section id="diary" class="py-20 px-4 bg-white dark:bg-slate-900 tab-content">
            <div class="max-w-5xl mx-auto px-4">
                <h2 class="text-3xl font-bold mb-6 text-center text-gray-800 dark:text-white">Shared Diary ğŸ“–</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-2xl border border-gray-100 dark:border-slate-700 shadow-sm">
                            <input type="text" id="diaryTitle" placeholder="Judul momen hari ini..." class="w-full p-3 bg-white dark:bg-slate-900 rounded-xl text-sm font-bold outline-none mb-2 shadow-sm dark:text-white">
                            <textarea id="diaryContent" rows="4" placeholder="Ceritain dong, ada kejadian apa?..." class="w-full p-3 bg-white dark:bg-slate-900 text-sm outline-none resize-none rounded-xl shadow-sm mb-2 dark:text-white"></textarea>
                            
                            <div class="flex flex-wrap md:flex-nowrap gap-2">
                                <div class="flex gap-2 flex-1 min-w-[200px]">
                                    <select id="diaryMood" class="p-2 rounded-xl bg-white dark:bg-slate-900 text-xl shadow-sm border border-gray-200 dark:border-slate-700 outline-none">
                                        <option value="ğŸ¥°">ğŸ¥°</option>
                                        <option value="ğŸ˜‚">ğŸ˜‚</option>
                                        <option value="ğŸ˜­">ğŸ˜­</option>
                                        <option value="ğŸ˜¡">ğŸ˜¡</option>
                                        <option value="ğŸ˜´">ğŸ˜´</option>
                                    </select>
                                    <input type="date" id="diaryDate" class="p-2 rounded-xl bg-white dark:bg-slate-900 text-xs shadow-sm flex-1 border border-gray-200 dark:border-slate-700 outline-none dark:text-white">
                                </div>
                                
                                <button onclick="saveDiary()" class="w-full md:w-auto bg-pink-500 hover:bg-pink-600 text-white px-8 py-2.5 rounded-xl font-bold text-sm shadow-lg transition transform active:scale-95 shrink-0">
                                    Simpan âœ¨
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-pink-100 dark:border-slate-700 shadow-lg flex flex-col justify-center">
                        <div class="flex justify-between items-center mb-2 border-b pb-2 dark:border-slate-700">
                            <h3 class="font-bold text-sm text-gray-500">Statistik Mood</h3>
                            <input type="month" id="diaryMonthFilter" class="text-xs p-1 rounded border bg-gray-50 dark:bg-slate-900 dark:text-white dark:border-slate-600" onchange="renderDiary()">
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <div class="w-24 h-24 flex-shrink-0">
                                <canvas id="moodChart"></canvas>
                            </div>
                            <div id="moodLegend" class="flex-1 text-xs space-y-1 grid grid-cols-2 gap-x-2 text-gray-600 dark:text-gray-300">
                                </div>
                        </div>
                        
                        <div id="moodSuggestionBox" class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800">
                            <p class="text-[10px] font-bold text-blue-500 uppercase mb-1">ğŸ’¡ Saran Untuk Pasangan:</p>
                            <p id="moodSuggestionText" class="text-xs text-gray-600 dark:text-gray-300 italic">Belum ada data...</p>
                        </div>
                    </div>
                </div>

                <div id="diaryList" class="space-y-4 pb-24 grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>
        </section>

        <section id="maps" class="py-20 px-4 bg-blue-50 dark:bg-slate-800 border-t border-blue-100 dark:border-slate-700 transition-colors duration-500 tab-content pb-32">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-4xl font-bold text-blue-800 dark:text-blue-300 mb-2">Our Journey ğŸ—ºï¸</h2>
                    <p class="text-blue-500 dark:text-blue-400">Cari tempat, tandai, dan simpan kenangan kita.</p>
                </div>
                
                <div class="bg-white dark:bg-slate-700 p-2 rounded-[2rem] shadow-xl border-4 border-white dark:border-slate-600 h-[400px] md:h-[500px] relative overflow-hidden group mb-8 z-0">
                    <div id="map" class="w-full h-full z-10 rounded-[1.5rem]"></div>
                    
                    <div id="searchInfoBox" class="hidden absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] bg-white/95 dark:bg-slate-800/95 backdrop-blur px-6 py-3 rounded-2xl shadow-lg flex items-center gap-3 animate-bounce">
                        <span class="text-2xl">ğŸ“</span>
                        <div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase">Lokasi Ditemukan</p>
                            <p id="searchResultName" class="text-sm font-bold text-gray-800 dark:text-white line-clamp-1">Nama Tempat</p>
                        </div>
                        <button onclick="openPinInputFromSearch()" class="bg-blue-500 text-white text-xs font-bold px-3 py-2 rounded-lg ml-2 hover:bg-blue-600">Simpan</button>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] p-6 shadow-lg border border-blue-100 dark:border-slate-700">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-xl text-gray-700 dark:text-white">ğŸ“ Daftar Lokasi (<span id="locCount">0</span>)</h3>
                        <button onclick="map.flyTo([-6.2088, 106.8456], 10)" class="text-xs font-bold text-blue-500 bg-blue-50 dark:bg-slate-700 px-3 py-2 rounded-full">Reset View</button>
                    </div>
                    <div id="locationList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        </div>
                    <div id="noLocMsg" class="text-center py-10 text-gray-400 text-sm hidden">Belum ada lokasi tersimpan. Cari di peta yuk!</div>
                </div>
            </div>
        </section>

        <section id="videos" class="py-20 px-4 bg-white dark:bg-slate-800 border-t border-gray-100 dark:border-slate-700 pb-40 transition-colors duration-500 tab-content">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-3xl font-bold text-center text-gray-800 dark:text-white mb-10">Video & Link Vault ğŸ”—</h2>
                <div class="max-w-3xl mx-auto bg-gray-50 dark:bg-slate-700 p-2 pl-4 rounded-full shadow-inner mb-16 flex flex-col md:flex-row gap-2 border border-gray-200 dark:border-slate-600">
                    <input type="text" id="videoUrl" placeholder="Tempel Link (YouTube/TikTok/IG)..." class="flex-1 bg-transparent p-2 focus:outline-none text-gray-700 dark:text-white">
                    <div class="h-8 w-px bg-gray-300 dark:bg-slate-500 my-auto hidden md:block"></div>
                    <input type="text" id="videoCaption" placeholder="Judul / Keterangan" class="md:w-1/3 bg-transparent p-2 focus:outline-none text-gray-700 dark:text-white">
                    <button onclick="window.addVideo()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-8 py-3 rounded-full shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 shrink-0">ğŸ’¾ Simpan</button>
                </div>
                <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                <div id="noVideoMsg" class="hidden text-center text-gray-400 dark:text-gray-500 py-20 bg-gray-50 dark:bg-slate-700 rounded-3xl border-2 border-dashed border-gray-200 dark:border-slate-600 flex flex-col items-center justify-center"><span class="text-4xl mb-3 opacity-50">ğŸ”—</span>Belum ada link tersimpan.</div>
            </div>
        </section>

        <footer class="fixed bottom-0 w-full bg-white/90 dark:bg-slate-900/90 py-2 text-center text-gray-400 text-[10px] backdrop-blur-sm z-[39] border-t dark:border-slate-800">
            <p>Made with ğŸ’– by Asep & Udel</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdB_cqR4QTYiUx9ik1ruZyXq88HqSfPVk",
            authDomain: "lovestory-kita.firebaseapp.com",
            databaseURL: "https://lovestory-kita-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lovestory-kita",
            storageBucket: "lovestory-kita.firebasestorage.app",
            messagingSenderId: "1076512835872",
            appId: "1:1076512835872:web:c0571708f387ac164cef45",
            measurementId: "G-PKE0C3QKD5"
        };

        // --- ERROR HANDLING AGAR SCRIPT TIDAK MATI TOTAL ---
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase Connected!");
        } catch (error) {
            console.error("Firebase Error:", error);
            alert("Gagal konek ke database. Cek internet kamu ya!");
        }

        const imgbbAPIKey = "45313df89cb1e741284dbeb8cbfba7f5"; 
        
        // --- VARIABEL GLOBAL ---
        let correctPin = "1234";
        let startRelationshipDate = new Date();
        let contactP1 = "6285883278505"; 
        let contactP2 = "6281284711123"; 
        let nameP1 = "Asep";
        let nameP2 = "Udel";
        let tempDeletePath = null;
        let isMusicPlaying = false;
        let moodChartInstance = null;
        let map = null;
        let tempMapLatLng = null;
        let tempWishLocation = null;
        let isPickingLocation = false;
        let currentSearchResult = null; // Menyimpan hasil search
        let selectionMode = false;
        let selectedMemories = new Set();
        
        // Variabel Gallery & Slideshow
        let currentGalleryImages = []; 
        let currentImageIndex = 0;      
        let currentAlbum = 'All';        

        // --- 1. FUNGSI UTAMA (DITARUH ATAS BIAR LANGSUNG KEBACA) ---
        
        // Wajib didefinisikan ke window agar bisa dipanggil dari HTML onclick
        window.selectUser = function(user) {
            window.currentUser = user;
            const screen = document.getElementById('welcomeScreen');
            const overlay = document.getElementById('pinOverlay');
            
            if(screen && overlay) {
                screen.classList.add('hidden');
                overlay.classList.remove('hidden');
                
                const name = user === 'p1' ? 'Asep' : 'Udel';
                const icon = user === 'p1' ? 'ğŸ¤´' : 'ğŸ‘¸';
                document.getElementById('loginGreeting').innerText = `Halo ${name}, masukkan passwordmu.`;
                document.getElementById('loginAvatar').innerText = icon;
                
                const passInput = document.getElementById('userPasswordInput');
                passInput.value = '';
                setTimeout(() => passInput.focus(), 100);
            } else {
                console.error("Elemen HTML tidak ditemukan!");
            }
        }

        window.cancelLogin = function() {
            document.getElementById('pinOverlay').classList.add('hidden');
            document.getElementById('welcomeScreen').classList.remove('hidden');
        }

        window.checkUserPassword = function() {
            const input = document.getElementById('userPasswordInput').value;
            const userPath = `profiles/${window.currentUser}`;
            
            get(ref(db, userPath)).then((snapshot) => {
                const userData = snapshot.val() || {};
                const truePass = userData.password || '1234'; 
                
                if(input === truePass) {
                    document.getElementById('pinOverlay').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('opacity-0');
                    
                    // Audio Play
                    const audio = document.getElementById('bgAudio');
                    const localSong = localStorage.getItem('localSong');
                    if(localSong) audio.src = localSong;
                    
                    audio.play().then(() => {
                        isMusicPlaying = true;
                        document.getElementById('musicIcon').innerHTML = 'ğŸµ';
                        document.getElementById('musicIcon').classList.add('animate-spin-slow');
                        document.getElementById('musicWidget').classList.remove('hidden');
                        document.getElementById('musicWidget').classList.add('flex');
                        document.getElementById('musicBtn').classList.remove('hidden');
                    }).catch(e => console.log("Audio perlu interaksi user dulu"));
                    
                    // Setup UI Awal
                    document.getElementById('diaryDate').valueAsDate = new Date();
                    const now = new Date();
                    document.getElementById('diaryMonthFilter').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                    
                    setTimeout(initMap, 500); // Delay dikit biar map loading bener
                    renderDiary();
                    window.loadStats(); 
                } else {
                    window.showPopup('Gagal', 'Password salah! (Default: 1234)', 'error');
                    document.getElementById('userPasswordInput').value = '';
                }
            }).catch(err => {
                console.error(err);
                // Fallback kalau offline/error db
                if(input === '1234') {
                     alert("Mode Offline: Login dengan pass default berhasil.");
                     document.getElementById('pinOverlay').classList.add('hidden');
                     document.getElementById('mainApp').classList.remove('opacity-0');
                     setTimeout(initMap, 500);
                }
            });
        }
        // --- NOTIFIKASI REALTIME LISTENER ---
        onValue(ref(db, 'notifications/missYou'), (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            // Cek apakah notifikasi ini ditujukan untuk user yang sedang login sekarang
            // Dan pastikan notifikasinya baru (kurang dari 10 detik yang lalu)
            const isForMe = data.target === window.currentUser;
            const isNew = (Date.now() - data.timestamp) < 10000; 

            if (isForMe && isNew) {
                // Mainkan suara (Opsional, pakai suara default browser)
                const msg = new SpeechSynthesisUtterance(`Sayang, ada pesan kangen dari ${data.sender}`);
                window.speechSynthesis.speak(msg);

                // Tampilkan Pop-up Besar
                window.showPopup("CIEEE KANGEN! â¤ï¸", `${data.sender} lagi kangen berat sama kamu sekarang!`, 'success');
                
                // Efek Confetti biar makin rame
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            }
        });
        // --- FUNGSI NAVIGASI ---
        window.switchTab = function(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const target = document.getElementById(tabId);
            if(target) target.classList.add('active');

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-active'));
            const navBtn = document.getElementById(`nav-${tabId}`);
            if(navBtn) navBtn.classList.add('nav-active');

            const mobBtn = document.getElementById(`mob-nav-${tabId}`);
            if(mobBtn) mobBtn.classList.add('nav-active');

            window.scrollTo(0, 0);
            // Fix map grey area
            if(tabId === 'maps' && map) {
                setTimeout(() => { map.invalidateSize(); }, 200);
            }
        }

        window.toggleMusic = function() {
            const audio = document.getElementById('bgAudio');
            const icon = document.getElementById('musicIcon');
            
            if (audio.paused) { 
                audio.play(); 
                icon.innerHTML = 'ğŸµ'; 
                icon.classList.add('animate-spin-slow'); 
                isMusicPlaying = true;
            } else { 
                audio.pause(); 
                icon.innerHTML = 'ğŸ”‡'; // Ikon mute
                icon.classList.remove('animate-spin-slow'); 
                isMusicPlaying = false;
            }
        }

        window.changeLocalMusic = function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                localStorage.setItem('localSong', e.target.result);
                const audio = document.getElementById('bgAudio');
                audio.src = e.target.result;
                audio.play();
                isMusicPlaying = true;
                document.getElementById('musicIcon').innerHTML = 'ğŸµ';
                document.getElementById('musicIcon').classList.add('animate-spin-slow');
                showPopup('Berhasil!', 'Lagu diganti di HP ini aja ğŸµ');
            }
            reader.readAsDataURL(file);
        }

        window.resetLocalMusic = function() {
            localStorage.removeItem('localSong');
            document.getElementById('bgAudio').src = "Yung Kai - Blue.mp3";
            showPopup('Reset', 'Balik ke lagu default.', 'success');
        }

        window.toggleDarkMode = function() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');

        window.saveDiary = function() {
            const t = document.getElementById('diaryTitle').value;
            const c = document.getElementById('diaryContent').value;
            const d = document.getElementById('diaryDate').value;
            const m = document.getElementById('diaryMood').value;

            if (!t || !c) return showPopup('Eits!', 'Judul & Isi wajib diisi!', 'error');
            
            const id = Date.now().toString();
            const authorName = window.currentUser || 'Anonymous'; 

            writeData(`diary/${id}`, { 
                id: id, 
                title: t, 
                date: d, 
                mood: m, 
                content: c, 
                timestamp: Date.now(), 
                author: authorName 
            });
            
            document.getElementById('diaryTitle').value=''; 
            document.getElementById('diaryContent').value=''; 
            showPopup('Tersimpan!', 'Diary baru! âœ¨');
        }

        // --- LIGHTBOX & UI HELPERS ---
        window.openLightbox = function(src) {
            currentImageIndex = currentGalleryImages.findIndex(img => img.url === src);
            updateLightboxImage();
            const lb = document.getElementById('lightbox');
            lb.classList.remove('hidden');
            setTimeout(() => lb.classList.remove('opacity-0'), 10);
        }
        
        window.updateLightboxImage = function() {
            if(currentGalleryImages.length > 0 && currentGalleryImages[currentImageIndex]) {
                const img = document.getElementById('lightboxImg');
                img.src = currentGalleryImages[currentImageIndex].url;
            }
        }
        
        window.prevImage = function(e) {
            e.stopPropagation();
            if(currentGalleryImages.length === 0) return;
            currentImageIndex = (currentImageIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length;
            updateLightboxImage();
        }
        
        window.nextImage = function(e) {
            e.stopPropagation();
            if(currentGalleryImages.length === 0) return;
            currentImageIndex = (currentImageIndex + 1) % currentGalleryImages.length;
            updateLightboxImage();
        }

        window.closeLightbox = function() {
            const lb = document.getElementById('lightbox');
            lb.classList.add('opacity-0');
            setTimeout(() => { lb.classList.add('hidden'); document.getElementById('lightboxImg').src = ''; }, 300);
        }
        
        window.toggleExtraMenu = function() {
            document.getElementById('extraMenu').classList.toggle('hidden');
        }

        // --- UPLOAD & POPUP ---
        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPIKey}`, { method: "POST", body: formData });
                const result = await response.json();
                if (result.success) return result.data.url;
                throw new Error("Gagal upload ke ImgBB");
            } catch (err) {
                console.error(err);
                throw err;
            }
        }

        window.showPopup = function(title, message, type = 'success', confirmAction = null) {
            const popup = document.getElementById('customPopup');
            const titleEl = document.getElementById('popupTitle');
            const msgEl = document.getElementById('popupMessage');
            const icon = document.getElementById('popupIcon');
            const actions = document.getElementById('popupActions');

            titleEl.innerText = title;
            msgEl.innerText = message;
            actions.innerHTML = ''; 

            if (type === 'success') { icon.innerHTML = 'ğŸ‰'; titleEl.className = 'text-2xl font-bold text-pink-600 mb-2 dark:text-pink-400'; } 
            else if (type === 'error') { icon.innerHTML = 'ğŸ¥º'; titleEl.className = 'text-2xl font-bold text-red-500 mb-2'; } 
            else if (type === 'loading') { icon.innerHTML = 'â³'; titleEl.className = 'text-2xl font-bold text-blue-500 mb-2'; }
            else if (type === 'confirm') { icon.innerHTML = 'ğŸ¤”'; titleEl.className = 'text-2xl font-bold text-gray-700 dark:text-gray-300 mb-2'; }

            if (type === 'confirm') {
                const btnCancel = document.createElement('button');
                btnCancel.className = "flex-1 bg-gray-100 dark:bg-slate-600 text-gray-500 dark:text-gray-400 py-3 rounded-xl font-bold transition-all active:scale-95";
                btnCancel.innerText = "Batal";
                btnCancel.onclick = window.closePopup;
                
                const btnOk = document.createElement('button');
                btnOk.className = "flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold shadow-lg transition-all active:scale-95";
                btnOk.innerText = "Ya, Lanjut";
                btnOk.onclick = () => { confirmAction(); window.closePopup(); };
                
                actions.appendChild(btnCancel);
                actions.appendChild(btnOk);
            } else {
                const btnOk = document.createElement('button');
                btnOk.className = "w-full bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95";
                btnOk.innerText = "Oke";
                btnOk.onclick = window.closePopup;
                actions.appendChild(btnOk);
            }

            popup.classList.remove('hidden');
            setTimeout(() => { popup.classList.remove('opacity-0'); }, 10);
        }

        window.closePopup = function() {
            const popup = document.getElementById('customPopup');
            const popupEl = document.getElementById('customPopup');
            popupEl.classList.add('opacity-0');
            setTimeout(() => { popupEl.classList.add('hidden'); }, 300);
        }

        window.showInputPopup = function(title, callback) {
            const popup = document.getElementById('customInputPopup');
            document.getElementById('customInputTitle').innerText = title;
            const field = document.getElementById('customInputField');
            field.value = '';
            popup.classList.remove('hidden');
            setTimeout(() => popup.classList.remove('opacity-0'), 10);
            field.focus();

            const btn = document.getElementById('customInputConfirmBtn');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.onclick = () => {
                if(field.value.trim()) {
                    callback(field.value.trim());
                    window.closeCustomInput();
                } else {
                    field.classList.add('ring-2', 'ring-red-500');
                    setTimeout(()=>field.classList.remove('ring-2', 'ring-red-500'), 500);
                }
            };
        }

        window.closeCustomInput = function() {
            const popup = document.getElementById('customInputPopup');
            popup.classList.add('opacity-0');
            setTimeout(() => { popup.classList.add('hidden'); }, 300);
        }

        // Fungsi membuat icon marker kustom HTML
        function createCustomIcon(user) {
            // P1 = Cowok (Biru), P2 = Cewek (Pink)
            const colorClass = user === 'p1' ? 'pin-p1' : 'pin-p2';
            const emoji = user === 'p1' ? 'ğŸ¤´' : 'ğŸ‘¸';
            
            return L.divIcon({
                className: 'cute-marker',
                html: `<div class="cute-pin-body ${colorClass}">
                         <span>${emoji}</span>
                       </div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40], // Ujung bawah tengah
                popupAnchor: [0, -45]
            });
        }

        window.initMap = function() {
            if(map) return;
            
            // 1. Init Map
            map = L.map('map').setView([-6.2088, 106.8456], 11);
            
            L.tileLayer('https://mt0.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
                attribution: 'Google Maps',
                maxZoom: 20,
                subdomains:['mt0','mt1','mt2','mt3']
            }).addTo(map);

            // 2. Tambahkan Search Bar (Geocoder)
            const geocoder = L.Control.geocoder({
                defaultMarkGeocode: false,
                placeholder: "Cari tempat kenangan...",
                errorMessage: "Yah, ga ketemu :("
            })
            .on('markgeocode', function(e) {
                const bbox = e.geocode.bbox;
                const poly = L.polygon([
                    bbox.getSouthEast(),
                    bbox.getNorthEast(),
                    bbox.getNorthWest(),
                    bbox.getSouthWest()
                ]);
                map.fitBounds(poly.getBounds());
                
                // Simpan hasil sementara
                tempMapLatLng = e.geocode.center;
                currentSearchResult = e.geocode.name;

                // Tampilkan Info Box Melayang
                const box = document.getElementById('searchInfoBox');
                const nameEl = document.getElementById('searchResultName');
                nameEl.innerText = e.geocode.name;
                box.classList.remove('hidden');

                // Tampilkan marker sementara (preview)
                L.popup()
                    .setLatLng(tempMapLatLng)
                    .setContent(`<div class="text-center"><b class="text-sm">${e.geocode.name}</b><br><button onclick="window.openPinInputFromSearch()" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-xs">Simpan Ini</button></div>`)
                    .openOn(map);
            })
            .addTo(map);

            // 3. Klik Manual di Peta
            map.on('click', function(e) {
                tempMapLatLng = e.latlng;
                currentSearchResult = ""; // Reset nama search kalo klik manual
                document.getElementById('searchInfoBox').classList.add('hidden'); // Sembunyikan info box
                
                if (isPickingLocation) {
                    // Logic Bucket List (kode lama tetep jalan)
                    tempWishLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
                    isPickingLocation = false; 
                    window.switchTab('wishlist');
                    const locStatus = document.getElementById('locStatus');
                    locStatus.innerText = "âœ… Terpilih"; 
                    locStatus.parentElement.classList.add('bg-green-100', 'text-green-600');
                    window.showPopup('Sip!', 'Lokasi sudah dipilih.');
                } 
                else {
                    // Buka popup input manual
                    const modal = document.getElementById('mapInputPopup');
                    modal.classList.remove('hidden');
                    setTimeout(() => { modal.classList.remove('opacity-0'); }, 10);
                    document.getElementById('mapNoteInput').value = ''; // Kosongkan dulu
                    document.getElementById('mapNoteInput').focus();
                }
            });

            // 4. Listen Data dari Firebase
            listenToData('locations', (data) => {
                const listContainer = document.getElementById('locationList');
                const noMsg = document.getElementById('noLocMsg');
                const countEl = document.getElementById('locCount');
                
                // Bersihkan marker lama & list
                map.eachLayer((layer) => { 
                    if(layer instanceof L.Marker) { map.removeLayer(layer); } 
                });
                listContainer.innerHTML = '';

                if(!data) {
                    noMsg.classList.remove('hidden');
                    countEl.innerText = '0';
                    return;
                }

                noMsg.classList.add('hidden');
                const locations = Object.values(data).reverse(); // Urutan terbaru
                countEl.innerText = locations.length;

                locations.forEach(loc => {
                    // A. Render Marker di Peta
                    // Tentukan user siapa yang bikin pin ini (default p1 kalau data lama)
                    const pinUser = loc.user || 'p1'; 
                    const customIcon = createCustomIcon(pinUser);

                    const marker = L.marker([loc.lat, loc.lng], {icon: customIcon}).addTo(map);
                    
                    const popupContent = `
                        <div class="text-center min-w-[150px]">
                            <p class="text-[10px] uppercase font-bold text-gray-400 mb-1">${pinUser === 'p1' ? 'ğŸ¤´ Asep' : 'ğŸ‘¸ Udel'} was here</p>
                            <h3 class="font-bold text-gray-800 text-sm mb-2">${loc.note}</h3>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lng}" target="_blank" class="text-blue-500 text-xs underline">Rute Google Maps</a>
                            <br>
                            <button onclick="window.askDelete('locations/${loc.id}')" class="text-red-500 text-[10px] mt-2 border border-red-200 px-2 py-1 rounded hover:bg-red-50">Hapus</button>
                        </div>
                    `;
                    marker.bindPopup(popupContent);

                    // B. Render List di Bawah
                    const item = document.createElement('div');
                    item.className = "location-card bg-gray-50 dark:bg-slate-700 p-4 rounded-2xl flex items-center gap-4 border border-gray-100 dark:border-slate-600 cursor-pointer";
                    item.onclick = () => {
                        map.flyTo([loc.lat, loc.lng], 16);
                        marker.openPopup();
                        window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll ke peta
                    };

                    item.innerHTML = `
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-sm shrink-0 ${pinUser==='p1'?'bg-blue-100 text-blue-500':'bg-pink-100 text-pink-500'}">
                            ${pinUser==='p1'?'ğŸ¤´':'ğŸ‘¸'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 dark:text-white truncate">${loc.note}</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Lat: ${loc.lat.toFixed(4)}, Lng: ${loc.lng.toFixed(4)}</p>
                        </div>
                        <button onclick="event.stopPropagation(); window.askDelete('locations/${loc.id}')" class="w-8 h-8 rounded-full bg-white dark:bg-slate-600 text-gray-400 hover:text-red-500 flex items-center justify-center shadow-sm transition">
                            ğŸ—‘ï¸
                        </button>
                    `;
                    listContainer.appendChild(item);
                });
            });
        }

        // Helper: Buka popup input jika klik tombol "Simpan" dari Search Bar
        window.openPinInputFromSearch = function() {
            const modal = document.getElementById('mapInputPopup');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); }, 10);
            
            // Otomatis isi nama tempat dari hasil search
            if(currentSearchResult) {
                document.getElementById('mapNoteInput').value = currentSearchResult;
            }
            document.getElementById('mapNoteInput').focus();
            document.getElementById('searchInfoBox').classList.add('hidden'); // Tutup info box
        }

        window.closeMapInput = function() {
            const modal = document.getElementById('mapInputPopup');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
            document.getElementById('mapNoteInput').value = '';
        }

        window.confirmAddMap = function() {
            const note = document.getElementById('mapNoteInput').value;
            if(note && tempMapLatLng) {
                const id = Date.now().toString();
                // Simpan user juga (window.currentUser)
                const user = window.currentUser || 'p1'; 
                
                writeData(`locations/${id}`, { 
                    id: id, 
                    lat: tempMapLatLng.lat, 
                    lng: tempMapLatLng.lng, 
                    note: note,
                    user: user // Tambahan: simpan siapa yg nambahin
                });
                
                window.closeMapInput();
                window.showPopup("Ditandai!", "Lokasi baru ditambahkan di peta ğŸ“");
            } else {
                window.showPopup("Ups", "Kasih nama tempatnya dulu dong!", "error");
            }
        }

        // --- IDENTITAS & PROFILE ---
        window.showIdentityPopup = function() {
            document.getElementById('btnNameP1').innerText = nameP1;
            document.getElementById('btnNameP2').innerText = nameP2;
            const popup = document.getElementById('identityPopup');
            popup.classList.remove('hidden');
            setTimeout(() => { popup.classList.remove('opacity-0'); }, 10);
        }

        window.closeIdentityPopup = function() {
            const popup = document.getElementById('identityPopup');
            popup.classList.add('opacity-0');
            setTimeout(() => { popup.classList.add('hidden'); }, 300);
        }

        window.processMissYou = function(role) {
            window.closeIdentityPopup();
            
            const senderName = role === 'p1' ? nameP1 : nameP2;
            const targetName = role === 'p1' ? nameP2 : nameP1;
            const targetWA = role === 'p1' ? contactP2 : contactP1; // Kirim ke nomor pasangan
            const message = `Sayang ${targetName}... ${senderName} lagi kangen banget sama kamu! â¤ï¸ Cek aplikasi kita yuk!`;

            // 1. KIRIM SINYAL KE FIREBASE (Agar muncul di web pasangan secara realtime)
            const missRef = ref(db, 'notifications/missYou');
            set(missRef, {
                sender: senderName,
                target: role === 'p1' ? 'p2' : 'p1', // Siapa yang harus dapet notif
                timestamp: Date.now()
            });

            // 2. KIRIM VIA WHATSAPP (Notifikasi HP yang paling terasa)
            const waUrl = `https://api.whatsapp.com/send?phone=${targetWA}&text=${encodeURIComponent(message)}`;
            
            window.showPopup("Kangen Terkirim!", `Sinyal kangen sudah dikirim ke ${targetName}!`, 'success', () => {
                window.open(waUrl, '_blank');
            });
        }

        window.toggleSettings = function() { document.getElementById('settingsPanel').classList.toggle('hidden'); }
        
        window.updatePin = function() {
            const newPin = document.getElementById('newPinInput').value;
            if (newPin.length >= 4) { set(ref(db, 'config/pin'), newPin); showPopup('Sukses!', 'PIN diganti!'); } 
            else { showPopup('Gagal', 'Minimal 4 karakter', 'error'); }
        }
        
        window.updateDate = function() {
            const d = document.getElementById('startDateInput').value;
            const t = document.getElementById('startTimeInput').value || "00:00";
            if(d) { set(ref(db, 'config/startDate'), new Date(`${d}T${t}`).toISOString()); showPopup('Sukses!', 'Tanggal update!'); }
        }

        window.updateContacts = function() {
            const name1 = document.getElementById('nameP1Input').value;
            const wa1 = document.getElementById('waP1Input').value;
            const name2 = document.getElementById('nameP2Input').value;
            const wa2 = document.getElementById('waP2Input').value;

            if(name1) set(ref(db, 'profiles/p1/name'), name1);
            if(wa1) set(ref(db, 'config/waP1'), wa1);
            if(name2) set(ref(db, 'profiles/p2/name'), name2);
            if(wa2) set(ref(db, 'config/waP2'), wa2);

            showPopup('Disimpan!', 'Identitas & Kontak berhasil update! ğŸ’–');
        }

        function listenToData(path, callback) { onValue(ref(db, path), (snapshot) => { callback(snapshot.val()); }); }
        function writeData(path, data) { set(ref(db, path), data); }

        // --- REALTIME UPDATES ---
        onValue(ref(db, 'config'), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                if (data.pin) correctPin = data.pin;
                if (data.waP1) { contactP1 = data.waP1; document.getElementById('waP1Input').value = data.waP1; }
                if (data.waP2) { contactP2 = data.waP2; document.getElementById('waP2Input').value = data.waP2; }
                if (data.startDate) {
                    startRelationshipDate = new Date(data.startDate);
                    document.getElementById('startDateDisplay').innerText = new Date(data.startDate).toLocaleDateString('id-ID', { dateStyle: 'full' });
                    const isoDate = new Date(data.startDate).toISOString();
                    document.getElementById('startDateInput').value = isoDate.split('T')[0];
                    document.getElementById('startTimeInput').value = isoDate.split('T')[1].substring(0,5);
                }
            }
        });

        listenToData('profiles', (data) => {
            if (data) {
                if (data.p1) { nameP1 = data.p1.name || "Cowok"; document.getElementById('nameP1').innerText = nameP1; document.getElementById('statusP1').innerText = data.p1.status || "Status..."; document.getElementById('nameP1Input').value = nameP1; if (data.p1.image) document.getElementById('imgP1').src = data.p1.image; }
                if (data.p2) { nameP2 = data.p2.name || "Cewek"; document.getElementById('nameP2').innerText = nameP2; document.getElementById('statusP2').innerText = data.p2.status || "Status..."; document.getElementById('nameP2Input').value = nameP2; if (data.p2.image) document.getElementById('imgP2').src = data.p2.image; }
                document.getElementById('btnNameP1').innerText = nameP1;
                document.getElementById('btnNameP2').innerText = nameP2;
            }
        });

        setInterval(() => {
            const now = new Date();
            const diff = now - startRelationshipDate;
            if (diff >= 0) {
                const years = Math.floor(diff / (1000 * 60 * 60 * 24 * 365));
                const days = Math.floor((diff % (1000 * 60 * 60 * 24 * 365)) / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                const timerEl = document.getElementById('loveTimer');
                if(timerEl) timerEl.innerHTML = `<div class="flex flex-col items-center bg-pink-50 dark:bg-slate-700 rounded-xl py-2"><span class="text-3xl font-black text-pink-600 dark:text-pink-400">${years}</span><span class="text-[10px] text-pink-400 dark:text-pink-300 uppercase font-bold">Tahun</span></div><div class="flex flex-col items-center bg-pink-50 dark:bg-slate-700 rounded-xl py-2"><span class="text-3xl font-black text-pink-600 dark:text-pink-400">${days}</span><span class="text-[10px] text-pink-400 dark:text-pink-300 uppercase font-bold">Hari</span></div><div class="flex flex-col items-center bg-gray-50 dark:bg-slate-800 rounded-xl py-2 border border-gray-100 dark:border-slate-600"><span class="text-2xl font-bold text-gray-600 dark:text-gray-300">${hours}</span><span class="text-[10px] text-gray-400 dark:text-gray-500 uppercase font-bold">Jam</span></div><div class="flex flex-col items-center bg-gray-50 dark:bg-slate-800 rounded-xl py-2 border border-gray-100 dark:border-slate-600"><span class="text-2xl font-bold text-gray-600 dark:text-gray-300">${minutes}</span><span class="text-[10px] text-gray-400 dark:text-gray-500 uppercase font-bold">Menit</span></div><div class="col-span-2 text-center text-xs text-pink-300 font-mono mt-1 animate-pulse">Running: ${seconds} seconds</div>`;
            }
        }, 1000);

        window.saveProfileText = function(u, f, id) { set(ref(db, `profiles/${u}/${f}`), document.getElementById(id).innerText); }
        window.changeProfilePic = async function(input, u) {
            if (input.files && input.files[0]) {
                showPopup('Upload...', 'Lagi kirim ke ImgBB...', 'loading');
                try {
                    const url = await uploadToImgBB(input.files[0]);
                    await set(ref(db, `profiles/${u}/image`), url);
                    showPopup('Berhasil!', 'Foto profil ganti! ğŸ˜');
                } catch (e) { showPopup('Gagal', 'Cek koneksi/API Key', 'error'); }
            }
        }

        // --- GALERI ---
        listenToData('gallery', (data) => {
            const allPhotos = data ? Object.values(data).reverse() : [];
            renderGallery(allPhotos);
        });

        function renderGallery(photos) {
            const grid = document.getElementById('photoGrid');
            
            if (!document.getElementById('albumControls')) {
                const albumDiv = document.createElement('div');
                albumDiv.id = 'albumControls';
                albumDiv.className = "flex gap-2 overflow-x-auto pb-4 mb-4 no-scrollbar";
                grid.parentNode.insertBefore(albumDiv, grid);
            }

            const uniqueAlbums = [...new Set(photos.map(p => p.album || 'Lainnya'))];
            const albumDiv = document.getElementById('albumControls');
            
            albumDiv.innerHTML = `
                <button onclick="switchAlbum('All')" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition shadow-sm ${currentAlbum === 'All' ? 'bg-pink-500 text-white shadow-pink-300' : 'bg-white text-gray-500 border border-gray-200'}">ğŸ“‚ Semua</button>
                <button onclick="createNewAlbum()" class="px-4 py-2 rounded-full text-xs font-bold bg-white text-pink-500 border border-pink-200 whitespace-nowrap hover:bg-pink-50 transition">+ Buat Album</button>
            `;

            uniqueAlbums.forEach(alb => {
                if(alb === 'Lainnya') return; 
                const btn = document.createElement('button');
                btn.innerText = `ğŸ“ ${alb}`;
                btn.onclick = () => switchAlbum(alb);
                btn.className = `px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition shadow-sm ${currentAlbum === alb ? 'bg-pink-500 text-white shadow-pink-300' : 'bg-white text-gray-500 border border-gray-200'}`;
                albumDiv.appendChild(btn);
            });

            const filteredPhotos = currentAlbum === 'All' ? photos : photos.filter(img => img.album === currentAlbum);
            currentGalleryImages = filteredPhotos;
            grid.innerHTML = '';
            
            if (filteredPhotos.length === 0) {
                document.getElementById('emptyMsg').classList.remove('hidden');
                document.querySelector('#emptyMsg p').innerText = currentAlbum === 'All' ? "Belum ada foto. Upload dong!" : `Album '${currentAlbum}' masih kosong.`;
            } else {
                document.getElementById('emptyMsg').classList.add('hidden');
                filteredPhotos.forEach((ph, index) => { 
                    const isSelected = selectedMemories.has(ph.id);
                    const d = document.createElement('div');
                    d.className = `group relative aspect-square overflow-hidden rounded-2xl shadow-sm hover:shadow-xl transition duration-300 border-2 ${isSelected ? 'border-pink-500' : 'border-transparent'}`;
                    d.innerHTML = `
                        <img src="${ph.url}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110" loading="lazy">
                        <div class="absolute inset-0 bg-black/10 group-hover:bg-black/20 transition"></div>
                        <div class="absolute top-2 right-2 z-20 ${selectionMode ? 'block' : 'hidden'}">
                             <div class="w-6 h-6 rounded-full border-2 border-white ${isSelected ? 'bg-pink-500' : 'bg-gray-400/50'} flex items-center justify-center text-white text-xs shadow-sm">âœ“</div>
                        </div>
                    `;
                    d.onclick = () => {
                        if (selectionMode) {
                            if (selectedMemories.has(ph.id)) selectedMemories.delete(ph.id);
                            else selectedMemories.add(ph.id);
                            renderGallery(photos); 
                            document.getElementById('selectedCount').innerText = selectedMemories.size;
                        } else {
                            currentImageIndex = index;
                            updateLightboxImage();
                            const lb = document.getElementById('lightbox');
                            lb.classList.remove('hidden');
                            setTimeout(() => lb.classList.remove('opacity-0'), 10);
                        }
                    };
                    grid.appendChild(d);
                });
            }
        }

        window.switchAlbum = function(albumName) {
            currentAlbum = albumName;
            listenToData('gallery', (data) => {
                const allPhotos = data ? Object.values(data).reverse() : [];
                renderGallery(allPhotos);
            });
        }

        window.createNewAlbum = function() {
            window.showInputPopup("âœ¨ Nama Album Baru:", (name) => {
                currentAlbum = name;
                showPopup('Album Siap!', `Sekarang upload foto buat album: ${name} ğŸ“¸`);
                switchAlbum(name);
            });
        }

        window.addPhotos = async function(input) {
            if (input.files && input.files.length > 0) {
                showPopup('Sabar ya...', `Lagi upload ${input.files.length} foto ke Album: ${currentAlbum === 'All' ? 'Lainnya' : currentAlbum}...`, 'loading');
                let successCount = 0;
                try {
                    for (let i = 0; i < input.files.length; i++) {
                        const file = input.files[i];
                        const url = await uploadToImgBB(file); 
                        const id = Date.now() + Math.random().toString().slice(2,5);
                        
                        await set(ref(db, `gallery/${id}`), { 
                            url: url, 
                            id: id,
                            album: currentAlbum === 'All' ? 'Lainnya' : currentAlbum,
                            timestamp: Date.now()
                        });
                        successCount++;
                    }
                    showPopup('Berhasil!', `${successCount} Foto berhasil disimpan! ğŸ‰`);
                } catch (e) { 
                    console.error(e);
                    showPopup('Yah gagal...', 'Cek koneksi internet kamu ya.', 'error'); 
                }
                input.value = '';
            }
        }

        window.toggleSelectionMode = function() {
            selectionMode = !selectionMode;
            selectedMemories.clear();
            document.getElementById('selectedCount').innerText = '0';
            
            const btn = document.getElementById('btnSelectMode');
            const delBtn = document.getElementById('btnDeleteSelected');
            
            if (selectionMode) {
                btn.innerHTML = 'âœ• Batal';
                btn.className = "bg-red-100 text-red-500 font-bold px-6 py-3 rounded-full shadow-md active:scale-95 transition";
                delBtn.classList.remove('hidden');
            } else {
                btn.innerHTML = 'âœ“ Pilih';
                btn.className = "bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 font-bold px-6 py-3 rounded-full shadow-md active:scale-95 transition";
                delBtn.classList.add('hidden');
            }
            listenToData('gallery', (data) => { }); 
        }

        window.deleteSelectedMemories = function() {
            if (selectedMemories.size === 0) return showPopup('Ups', 'Pilih foto dulu dong!', 'error');
            
            window.showPopup('Hapus Banyak?', `Yakin mau hapus ${selectedMemories.size} foto?`, 'confirm', () => {
                const updates = {};
                selectedMemories.forEach(id => {
                    updates[`gallery/${id}`] = null;
                });
                
                update(ref(db), updates).then(() => {
                    showPopup('Terhapus!', 'Foto-foto terpilih sudah dihapus.');
                    toggleSelectionMode();
                }).catch(e => showPopup('Gagal', 'Error hapus data.', 'error'));
            });
        }

        window.askDelete = function(path) {
            tempDeletePath = path;
            window.showPopup('Hapus Kenangan?', 'Data ini bakal hilang selamanya lho...', 'confirm', () => {
                 window.executeDelete();
            });
        }

        window.executeDelete = function() {
            if (tempDeletePath) {
                remove(ref(db, tempDeletePath))
                    .then(() => { setTimeout(() => showPopup('Terhapus!', 'Kenangan sudah dihapus ğŸƒ'), 350); })
                    .catch(() => { showPopup('Ups!', 'Gagal menghapus.', 'error'); });
            }
        }

        // --- BUCKET LIST ---
        listenToData('wishlist', (data) => {
            const g = document.getElementById('wishlistGrid');
            if(!g) return;
            g.innerHTML = '';
            g.className = "flex flex-col gap-4 pb-24"; 

            const w = data ? Object.values(data).sort((a,b)=>b.timestamp-a.timestamp) : [];
            document.getElementById('totalWishes').innerText = w.length;
            document.getElementById('completedWishes').innerText = w.filter(i => i.done).length;

            if(w.length===0) document.getElementById('noWishMsg').classList.remove('hidden');
            else {
                document.getElementById('noWishMsg').classList.add('hidden');
                w.forEach(wish=>{
                    const c = document.createElement('div');
                    c.className = `p-4 rounded-2xl border flex justify-between items-center transition ${wish.done?'bg-green-50 border-green-200 opacity-80':'bg-white border-pink-100 shadow-sm'}`;
                    const cost = wish.cost ? new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(Number(wish.cost)) : 'Gratis';
                    const locBtn = wish.location 
                        ? `<button onclick="window.switchTab('maps'); setTimeout(()=>{map.setView([${wish.location.lat}, ${wish.location.lng}], 16);},300);" class="text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded mt-1 font-bold inline-flex items-center gap-1 hover:bg-blue-200 transition">ğŸ“ Lihat Peta</button>` 
                        : '';

                    c.innerHTML = `
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 dark:text-white ${wish.done?'line-through text-gray-400':''}">${wish.name}</h4>
                            <div class="text-xs text-pink-500 font-bold mt-1">${cost}</div>
                            ${wish.link !== '#' ? `<a href="${wish.link}" target="_blank" class="text-[10px] text-blue-500 underline block mt-1">ğŸ”— Link</a>` : ''}
                            ${locBtn} </div>
                        <div class="flex gap-2">
                            <button onclick="toggleWish('${wish.id}',${wish.done})" class="px-3 py-2 rounded-lg text-xs font-bold ${wish.done?'bg-white text-green-500 border border-green-200':'bg-pink-500 text-white shadow'}">${wish.done?'Batal':'âœ…'}</button>
                            <button onclick="askDelete('wishlist/${wish.id}')" class="px-3 py-2 bg-gray-100 dark:bg-slate-700 text-gray-400 rounded-lg hover:text-red-500">ğŸ—‘ï¸</button>
                        </div>
                    `;
                    g.appendChild(c);
                });
            }
        });

        window.addWish = function() {
            const n = document.getElementById('wishName').value; 
            if(!n) return showPopup('Hmm..','Nama barang?', 'error');
            
            const id = Date.now().toString();
            writeData(`wishlist/${id}`, { 
                id, 
                name: n, 
                cost: document.getElementById('wishCost').value||0, 
                link: document.getElementById('wishLink').value||'#', 
                location: tempWishLocation, 
                done: false, 
                timestamp: Date.now() 
            });

            document.getElementById('wishName').value=''; 
            document.getElementById('wishCost').value=''; 
            document.getElementById('wishLink').value='';
            
            tempWishLocation = null;
            document.getElementById('locStatus').innerText = "Pilih Lokasi";
            document.getElementById('locStatus').parentElement.classList.remove('bg-green-100', 'text-green-600');

            showPopup('Siap!', 'Masuk Bucket List!');
        }
        
        window.pickMapLocationForWish = function() {
            isPickingLocation = true;
            window.switchTab('maps'); 
            window.showPopup('Pilih Lokasi', 'Klik titik di peta untuk lokasi Bucket List ini ğŸ“');
        }

        window.toggleWish = function(id, s) { set(ref(db, `wishlist/${id}/done`), !s); }

        // --- DIARY LOGIC ---
        window.renderDiary = function() {
            const monthFilter = document.getElementById('diaryMonthFilter').value; 
            
            onValue(ref(db, 'diary'), (snap) => {
                const data = snap.val() || {};
                const allDiaries = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);
                const filtered = monthFilter ? allDiaries.filter(d => d.date.startsWith(monthFilter)) : allDiaries;
                
                const list = document.getElementById('diaryList');
                if(!list) return;
                list.innerHTML = '';
                
                if(filtered.length === 0) {
                    list.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10 italic">Belum ada cerita di bulan ini.</div>`;
                } else {
                    filtered.forEach(d => {
                        const div = document.createElement('div');
                        div.className = "bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border-l-4 border-pink-400 dark:border-pink-600 flex flex-col justify-between";
                        
                        let itemAdvice = "";
                        if(d.mood === 'ğŸ˜­') itemAdvice = "Peluk dia erat-erat ya! ğŸ«‚";
                        if(d.mood === 'ğŸ˜¡') itemAdvice = "Sabar, dengerin dulu penjelasannya. ğŸ¤«";
                        if(d.mood === 'ğŸ˜´') itemAdvice = "Jangan diganggu, biarin istirahat. ğŸ›Œ";

                        div.innerHTML = `
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-3xl">${d.mood}</span>
                                    <div class="text-right">
                                        <span class="text-[10px] text-gray-400 font-bold block">${d.date}</span>
                                        <span class="text-[10px] bg-gray-100 dark:bg-slate-700 px-2 py-0.5 rounded text-gray-500">Oleh: ${d.author === 'p1' ? 'Asep' : 'Udel'}</span>
                                    </div>
                                </div>
                                <h4 class="font-bold text-lg text-gray-800 dark:text-white mb-1">${d.title}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-300 whitespace-pre-wrap leading-relaxed">${d.content}</p>
                            </div>
                            ${itemAdvice ? `<div class="mt-3 text-[10px] bg-yellow-50 dark:bg-slate-700 text-yellow-700 dark:text-yellow-400 p-2 rounded-lg">ğŸ’¡ ${itemAdvice}</div>` : ''}
                            <button onclick="deleteData('diary/${d.id}')" class="self-end text-[10px] text-red-400 mt-2 hover:text-red-600">ğŸ—‘ï¸ Hapus</button>
                        `;
                        list.appendChild(div);
                    });
                }
                updateMoodChart(filtered);
            });
        }
        
        window.deleteData = function(path) {
            window.askDelete(path);
        }

        function updateMoodChart(data) {
            const moods = { 'ğŸ¥°':0, 'ğŸ˜‚':0, 'ğŸ˜­':0, 'ğŸ˜¡':0, 'ğŸ˜´':0 };
            data.forEach(d => { if(moods[d.mood] !== undefined) moods[d.mood]++ });
            
            const ctx = document.getElementById('moodChart');
            if(window.myMoodChart) window.myMoodChart.destroy();
            
            window.myMoodChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [], 
                    datasets: [{ data: Object.values(moods), backgroundColor: ['#f472b6', '#fbbf24', '#60a5fa', '#f87171', '#9ca3af'], borderWidth: 0 }]
                },
                options: { responsive: true, cutout: '70%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });

            const legendBox = document.getElementById('moodLegend');
            legendBox.innerHTML = `
                <div class="flex justify-between"><span>ğŸ¥° Love</span> <b>${moods['ğŸ¥°']}</b></div>
                <div class="flex justify-between"><span>ğŸ˜‚ Lucu</span> <b>${moods['ğŸ˜‚']}</b></div>
                <div class="flex justify-between"><span>ğŸ˜­ Sedih</span> <b>${moods['ğŸ˜­']}</b></div>
                <div class="flex justify-between"><span>ğŸ˜¡ Marah</span> <b>${moods['ğŸ˜¡']}</b></div>
                <div class="flex justify-between"><span>ğŸ˜´ Capek</span> <b>${moods['ğŸ˜´']}</b></div>
            `;

            let maxMood = 'ğŸ¥°';
            if (data.length > 0) {
                 maxMood = Object.keys(moods).reduce((a, b) => moods[a] > moods[b] ? a : b);
            }
            const suggestions = {
                'ğŸ¥°': "Bulan penuh cinta! Ajak dia dinner romantis dong! ğŸŒ¹",
                'ğŸ˜‚': "Kalian asik banget! Pertahankan humornya ya. ğŸ˜†",
                'ğŸ˜­': "Dia lagi sensitif. Coba kasih coklat atau pelukan. ğŸ«",
                'ğŸ˜¡': "Hati-hati, lagi 'senggol bacok'. Bicara pelan-pelan ya. ğŸ³ï¸",
                'ğŸ˜´': "Kayaknya butuh liburan atau tidur seharian bareng. ğŸ’¤"
            };
            
            const suggestionText = data.length > 0 ? suggestions[maxMood] : "Belum ada data mood bulan ini.";
            document.getElementById('moodSuggestionText').innerText = suggestionText;
        }

        // --- VIDEO VAULT & SAFER REGEX ---
        listenToData('videos', (data) => {
            const g = document.getElementById('videoGrid');
            if(!g) return;
            g.innerHTML = ''; 
            const v = data ? Object.values(data).reverse() : [];
            
            if(v.length===0) document.getElementById('noVideoMsg').classList.remove('hidden'); 
            else { 
                document.getElementById('noVideoMsg').classList.add('hidden'); 
                v.forEach(vid=>{
                    const c = document.createElement('div');
                    const fullUrl = vid.url || `https://www.youtube.com/watch?v=${vid.id}`;
                    
                    // Regex yang lebih aman (Short Circuit Check)
                    let ytId = false;
                    try {
                        const match = fullUrl.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);
                        if(match && match[7].length === 11) ytId = match[7];
                    } catch(e) { console.log('Bukan link YT standard'); }

                    const contentHTML = ytId 
                        ? `<div class="relative w-full aspect-video bg-black"><iframe class="absolute inset-0 w-full h-full" src="https://www.youtube-nocookie.com/embed/${ytId}?rel=0&modestbranding=1" frameborder="0" allowfullscreen></iframe></div>` 
                        : `<div class="relative w-full aspect-video bg-indigo-500 flex items-center justify-center text-white flex-col"><span class="text-3xl">ğŸ”—</span><span class="text-xs mt-2 uppercase font-bold">External Link</span></div>`;
                    
                    c.className = "bg-white dark:bg-slate-800 rounded-3xl shadow-lg overflow-hidden fade-in flex flex-col border border-gray-100 dark:border-slate-700 group h-full";
                    c.innerHTML = `${contentHTML}<div class="p-5 flex justify-between items-center bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex-1"><div class="w-full"><h4 class="font-bold text-gray-800 dark:text-white text-sm line-clamp-2 mb-3" title="${vid.caption}">${vid.caption}</h4><div class="flex justify-between items-center"><a href="${fullUrl}" target="_blank" class="text-[10px] bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 px-3 py-1 rounded-full font-bold uppercase">Buka Link</a><button onclick="askDelete('videos/${vid.dbId}')" class="text-gray-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100">ğŸ—‘ï¸</button></div></div></div>`;
                    g.appendChild(c);
                });
            }
        });

        window.addVideo = function() {
            const u = document.getElementById('videoUrl').value; if(!u||!u.includes('http')) return showPopup('Error','Link gak valid','error');
            const id = Date.now().toString();
            writeData(`videos/${id}`, { dbId: id, url: u, caption: document.getElementById('videoCaption').value||'Link' });
            document.getElementById('videoUrl').value=''; document.getElementById('videoCaption').value=''; showPopup('Mantap!','Link disimpan.');
        }

        window.handleSharedLink = function(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const found = text.match(urlRegex);
            if(found && found.length > 0) {
                const url = found[0];
                document.getElementById('videoUrl').value = url;
                window.switchTab('videos');
                if(typeof Android !== 'undefined') Android.showToast("Link dari Share diterima! Klik Simpan.");
            }
        }

        // --- INIT SAFER ONLOAD ---
        window.addEventListener('load', function() {
            if(window.location.hash === '#diary') {
                window.switchTab('diary');
                document.getElementById('diaryTitle').focus();
            }
        });

        console.log("Script App Loaded Correctly!");
        // --- FITUR GAME STATS ---

        // Fungsi mengambil data stats
        window.loadStats = function() {
            onValue(ref(db, 'stats'), (snapshot) => {
                const data = snapshot.val() || {};
                renderStats('p1', data.p1 || { Loyalty: 90, Humor: 85, Patience: 70 });
                renderStats('p2', data.p2 || { Loyalty: 95, Humor: 80, Patience: 85 });
            });
        }

        function renderStats(user, stats) {
            const container = document.getElementById(`stats${user.toUpperCase()}`);
            if(!container) return;
            container.innerHTML = '';

            Object.entries(stats).forEach(([name, level]) => {
                const colorClass = level < 40 ? 'bar-low' : (level < 80 ? 'bar-mid' : 'bar-high');
                const div = document.createElement('div');
                div.className = 'stat-row group';
                div.innerHTML = `
                    <div class="stat-label">
                        <span contenteditable="true" onblur="renameStat('${user}', '${name}', this.innerText)" class="outline-none">${name}</span>
                        <span>LVL ${level}</span>
                    </div>
                    <div class="stat-bar-bg">
                        <div class="stat-bar-fill ${colorClass}" style="width: ${level}%"></div>
                    </div>
                    <div class="stat-controls opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="btn-stat" onclick="updateStatLevel('${user}', '${name}', -5)">-</button>
                        <button class="btn-stat" onclick="updateStatLevel('${user}', '${name}', 5)">+</button>
                        <button class="btn-stat text-red-400" onclick="deleteStat('${user}', '${name}')">Ã—</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        window.updateStatLevel = function(user, statName, change) {
            get(ref(db, `stats/${user}/${statName}`)).then((snap) => {
                let current = snap.val() || 0;
                let next = Math.min(100, Math.max(0, current + change));
                set(ref(db, `stats/${user}/${statName}`), next);
            });
        }

        window.addNewStat = function(user) {
            // Pastikan showInputPopup sudah kamu buat sebelumnya
            window.showInputPopup("âœ¨ Tambah Sifat Baru:", (name) => {
                if (name) {
                    // Kita simpan ke database dengan nilai awal 50
                    const statRef = ref(db, `stats/${user}/${name}`);
                    set(statRef, 50).then(() => {
                        showPopup("Berhasil!", `Sifat ${name} ditambahkan!`);
                    }).catch((err) => {
                        showPopup("Gagal", "Error simpan data", "error");
                    });
                }
            });
        }

        window.deleteStat = function(user, name) {
            remove(ref(db, `stats/${user}/${name}`));
        }

        window.renameStat = function(user, oldName, newName) {
            newName = newName.trim();
            if(!newName || oldName === newName) return;
            
            const oldRef = ref(db, `stats/${user}/${oldName}`);
            get(oldRef).then((snap) => {
                const val = snap.val();
                const updates = {};
                updates[`stats/${user}/${newName}`] = val;
                updates[`stats/${user}/${oldName}`] = null;
                update(ref(db), updates);
            });
        }

        // Panggil fungsi loadStats di dalam checkUserPassword atau inisialisasi awal
        // Tambahkan baris ini di dalam fungsi checkUserPassword:
        // loadStats();
        // --- FITUR AUTO PAUSE SAAT PINDAH TAB ---
        document.addEventListener("visibilitychange", () => {
            const audio = document.getElementById('bgAudio');
            const icon = document.getElementById('musicIcon');

            if (document.hidden) {
                // Jika tab tidak dilihat (pindah tab/minimize)
                audio.pause();
                if(icon) icon.classList.remove('animate-spin-slow');
            } else {
                // Jika user balik lagi ke web
                // Kita hanya putar lagi kalau sebelumnya statusnya memang sedang 'Playing'
                if (isMusicPlaying) {
                    audio.play().catch(e => console.log("Autoplay dicegah browser"));
                    if(icon) {
                        icon.innerHTML = 'ğŸµ';
                        icon.classList.add('animate-spin-slow');
                    }
                }
            }
        });
    </script>
</body>
</html>