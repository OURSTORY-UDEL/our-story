<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Story ğŸ’– Asep & Udel</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ec4899">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Quicksand', 'sans-serif'] },
                    colors: { dark: { bg: '#1a1a2e', card: '#16213e', text: '#e94560' } }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        
        body { -webkit-tap-highlight-color: transparent; font-family: 'Quicksand', sans-serif; }
        
        /* Animasi */
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .float-anim { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        
        .heartbeat { animation: heartbeat 1.5s infinite; }
        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .animate-marquee { animation: marquee 8s linear infinite; } 
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        
        .animate-spin-slow { animation: spin 4s linear infinite; } 
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Utilitas */
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #map { z-index: 10; border-radius: 1.5rem; height: 100%; width: 100%; }
        
        /* Nav Active State */
        .nav-active span { transform: scale(1.2); display: inline-block; transition: transform 0.2s; }
        .nav-active { color: #ec4899; font-weight: bold; }
        .dark .nav-active { color: #f472b6; }

        /* Checkbox untuk Batch Delete */
        .select-checkbox { display: none; }
        .selection-mode .select-checkbox { display: block; }

        /* Extra Menu Popup Animation */
        .extra-menu-enter { transform: translateY(100%); opacity: 0; }
        .extra-menu-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease-out; }
        .extra-menu-exit { transform: translateY(0); opacity: 1; }
        .extra-menu-exit-active { transform: translateY(100%); opacity: 0; transition: all 0.2s ease-in; }

        /* --- PERBAIKAN LAYOUT KHUSUS MOBILE --- */

        /* 1. Header Title (Our Story) - Sejajar Hamburger */
        .header-mobile-fix {
            top: 0;
            padding-top: max(0.5rem, env(safe-area-inset-top));
            height: auto;
            min-height: 3.5rem;
            align-items: center;
        }

        /* 2. Hamburger Menu - Turun dikit biar sejajar */
        .fixed.top-5.left-5 {
            top: max(1rem, env(safe-area-inset-top));
            z-index: 60;
        }

        /* 3. Header Profil - Padding biar gak kepotong */
        #header-profil {
            padding-top: calc(5rem + env(safe-area-inset-top)); 
            padding-bottom: 2rem;
        }

        /* 4. Scroll Fix (Biar item terakhir tidak ngumpet di input) */
        #wishlistGrid, #diaryList, #videoGrid {
            padding-bottom: 12rem !important; 
        }

        /* 5. Navigasi Bawah - Safe Area */
        nav.fixed.bottom-0 {
            padding-bottom: max(1rem, env(safe-area-inset-bottom));
            height: auto;
            min-height: 4.5rem;
        }

        /* Style Folder Album */
        .folder-tab-active { background-color: #ec4899 !important; color: white !important; }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-50 to-white dark:from-slate-900 dark:to-slate-800 text-gray-700 dark:text-gray-200 overflow-x-hidden pb-24 transition-colors duration-500" id="bodyContent">

    <div id="welcomeScreen" class="fixed inset-0 z-[300] bg-gradient-to-br from-pink-100 to-purple-100 dark:from-slate-900 dark:to-purple-900 flex flex-col items-center justify-center text-center p-6 transition duration-1000">
        <div class="relative w-32 h-32 mb-6">
            <div class="absolute inset-0 bg-pink-400 rounded-full animate-ping opacity-20"></div>
            <div class="relative bg-white dark:bg-slate-800 p-2 rounded-full shadow-xl">
                <span class="text-6xl">ğŸ’Œ</span>
            </div>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">Our Love App</h1>
        <p class="text-gray-500 dark:text-gray-300 mb-8 text-sm">Spesial buat kamu...</p>
        <button onclick="enterApp()" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold py-4 px-12 rounded-full shadow-xl hover:scale-105 transition transform active:scale-95 heartbeat">
            Buka Sekarang â¤ï¸
        </button>
    </div>

    <audio id="bgAudio" loop>
        <source src="Yung Kai - Blue.mp3" type="audio/mpeg">
    </audio>

    <div class="md:hidden fixed left-0 w-full bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-b border-pink-100 dark:border-slate-800 z-40 flex items-center justify-center shadow-sm header-mobile-fix">
        <div class="text-lg font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-600 tracking-widest">OUR STORY ğŸ’–</div>
    </div>

    <button onclick="toggleSettings()" class="md:hidden fixed top-5 left-5 text-gray-500 dark:text-gray-300 hover:text-pink-500 transition-colors duration-300 transform active:scale-90">
        <i class="fas fa-bars text-3xl drop-shadow-sm"></i>
    </button>

    <div class="fixed bottom-20 right-4 z-[50] flex flex-col items-end gap-2" style="bottom: calc(5rem + env(safe-area-inset-bottom));">
        <div id="musicWidget" class="hidden glass px-3 py-1.5 rounded-full shadow-lg items-center gap-2 max-w-[120px] bg-white dark:bg-slate-800">
            <div class="w-full overflow-hidden whitespace-nowrap">
                <p class="text-[10px] font-bold text-pink-500 animate-marquee inline-block">ğŸµ Yung Kai - Blue ğŸµ</p>
            </div>
        </div>
        <button onclick="toggleMusic()" id="musicBtn" class="glass p-3 rounded-full shadow-lg hidden active:scale-90 transition bg-white dark:bg-slate-800">
            <div id="musicIcon" class="animate-spin-slow text-lg">ğŸµ</div>
        </button>
    </div>

    <button onclick="showIdentityPopup()" class="fixed bottom-20 left-4 z-[50] glass p-3 rounded-full shadow-[0_0_15px_rgba(236,72,153,0.5)] heartbeat group transition hover:scale-110 active:scale-90 bg-white dark:bg-slate-800" style="bottom: calc(5rem + env(safe-area-inset-bottom));">
        <span class="text-3xl">ğŸ’–</span>
    </button>

    <div id="customInputPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[400] flex items-center justify-center hidden opacity-0 transition-opacity duration-300 px-6">
        <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-6 shadow-2xl w-full max-w-sm scale-in border-4 border-pink-200 dark:border-slate-600">
            <h3 class="text-xl font-bold text-pink-500 mb-2" id="customInputTitle">Judul</h3>
            <input type="text" id="customInputField" class="w-full p-4 bg-gray-50 dark:bg-slate-900 rounded-xl mb-6 focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm dark:text-white" placeholder="...">
            <div class="flex gap-3">
                <button onclick="closeCustomInput()" class="flex-1 bg-gray-100 dark:bg-slate-700 text-gray-500 py-3 rounded-xl font-bold text-sm">Batal</button>
                <button id="customInputConfirmBtn" class="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Simpan</button>
            </div>
        </div>
    </div>

    <div id="pinOverlay" class="hidden fixed inset-0 bg-gradient-to-br from-pink-400 via-purple-400 to-indigo-400 z-[200] flex flex-col items-center justify-center text-white transition duration-700">
        <div class="text-center p-8 w-full max-w-sm scale-in">
            <div class="text-6xl mb-4 animate-bounce">ğŸ”’</div>
            <h1 class="text-3xl font-bold mb-2">Locked App</h1>
            <p class="mb-8 text-pink-100 opacity-90 text-sm">Masukin PIN rahasia kita.</p>
            <div class="flex flex-col gap-4 items-center w-full">
                <input type="password" id="pinInput" maxlength="6" class="text-center text-3xl text-pink-600 p-4 rounded-2xl w-3/4 tracking-[0.5em] focus:outline-none focus:ring-4 focus:ring-pink-200 shadow-2xl font-bold placeholder-pink-200 bg-white" placeholder="****">
                <button onclick="checkPin()" class="bg-white/20 border border-white/50 text-white font-bold py-3 px-12 rounded-full shadow-lg hover:bg-white hover:text-pink-500 transition transform active:scale-95 w-3/4">Buka â¤ï¸</button>
            </div>
        </div>
    </div>

    <div id="customPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[250] flex items-center justify-center hidden transition-opacity duration-300 opacity-0 px-6">
        <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-8 shadow-2xl w-full max-w-sm text-center scale-in border-4 border-pink-100 dark:border-slate-700">
            <div id="popupIcon" class="text-6xl mb-4 filter drop-shadow-md">ğŸ‰</div>
            <h3 id="popupTitle" class="text-xl font-bold text-gray-800 dark:text-white mb-2">Title</h3>
            <p id="popupMessage" class="text-gray-500 dark:text-gray-400 text-sm mb-8 leading-relaxed font-medium">Message</p>
            <div id="popupActions" class="flex gap-3 justify-center"></div>
        </div>
    </div>

    <div id="identityPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[260] flex items-center justify-center hidden transition-opacity duration-300 opacity-0 px-6">
        <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] p-8 shadow-2xl w-full max-w-sm text-center scale-in border-4 border-pink-200 dark:border-slate-600 relative">
            <button onclick="closeIdentityPopup()" class="absolute top-5 right-5 text-gray-300 hover:text-red-500 text-xl font-bold">âœ•</button>
            <div class="text-5xl mb-4">ğŸ””</div>
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-1">Kangen Banget?</h3>
            <p class="text-xs text-gray-400 mb-8">Bunyikan notifikasi di HP pasangan kamu!</p>
            <div class="flex flex-col gap-4">
                <button onclick="processMissYou('p1')" class="bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 border-2 border-blue-100 dark:border-blue-800 font-bold py-4 rounded-2xl hover:bg-blue-100 transition active:scale-95 flex items-center justify-center gap-3">
                    <span class="text-2xl">ğŸ¤´</span> Aku <span id="btnNameP1">Cowok</span>
                </button>
                <button onclick="processMissYou('p2')" class="bg-pink-50 dark:bg-pink-900/30 text-pink-600 dark:text-pink-300 border-2 border-pink-100 dark:border-pink-800 font-bold py-4 rounded-2xl hover:bg-pink-100 transition active:scale-95 flex items-center justify-center gap-3">
                    <span class="text-2xl">ğŸ‘¸</span> Aku <span id="btnNameP2">Cewek</span>
                </button>
            </div>
        </div>
    </div>

    <div id="mapInputPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[260] flex items-center justify-center hidden transition-opacity duration-300 opacity-0 px-6">
        <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-8 shadow-2xl w-full max-w-sm text-center scale-in border-4 border-blue-100 dark:border-slate-700">
            <div class="text-5xl mb-4">ğŸ“</div>
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Tandai Lokasi</h3>
            <p class="text-xs text-gray-400 mb-6">Kasih nama tempat kenangan ini.</p>
            <input type="text" id="mapNoteInput" placeholder="Contoh: Tempat Pertama Ketemu" class="w-full p-4 bg-gray-50 dark:bg-slate-900 rounded-xl mb-6 focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm font-bold text-gray-700 dark:text-white text-center border border-gray-200 dark:border-slate-600">
            <div class="flex gap-3">
                <button onclick="closeMapInput()" class="flex-1 bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-400 py-3 rounded-xl font-bold text-sm">Batal</button>
                <button onclick="confirmAddMap()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg active:scale-95">Simpan</button>
            </div>
        </div>
    </div>

    <div id="lightbox" class="fixed inset-0 bg-black/95 z-[400] hidden flex flex-col justify-center items-center transition-opacity duration-300 opacity-0">
        <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white text-4xl font-bold z-50 p-2 hover:text-gray-300 transition">&times;</button>
        <button onclick="prevImage(event)" class="absolute left-0 top-1/2 transform -translate-y-1/2 text-white text-5xl p-4 hover:text-gray-300 transition z-50 outline-none">â®</button>
        <button onclick="nextImage(event)" class="absolute right-0 top-1/2 transform -translate-y-1/2 text-white text-5xl p-4 hover:text-gray-300 transition z-50 outline-none">â¯</button>
        <img id="lightboxImg" src="" class="max-w-[95%] max-h-[85%] rounded-xl shadow-2xl scale-in object-contain transition-all duration-300">
        <p class="text-white mt-4 text-xs font-bold opacity-70 bg-black/20 px-4 py-2 rounded-full">Geser Kiri / Kanan</p>
    </div>

    <div id="mainApp" class="opacity-0 transition duration-1000 min-h-screen flex flex-col">
        
        <nav class="hidden md:block bg-white/70 dark:bg-slate-900/70 backdrop-blur-md border-b border-pink-100 dark:border-slate-800 sticky top-0 z-40 transition-colors duration-500">
            <div class="max-w-6xl mx-auto px-6 h-20 flex justify-between items-center">
                <div class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-600 tracking-wider">OUR STORY ğŸ’–</div>
                <div class="flex gap-8 text-sm font-bold text-gray-500 dark:text-gray-400">
                    <a href="#header-profil" class="hover:text-pink-500 transition">Profil</a>
                    <a href="#gallery" class="hover:text-pink-500 transition">Memories</a>
                    <a href="#wishlist" class="hover:text-pink-500 transition">Bucket List</a>
                    <a href="#diary" class="hover:text-pink-500 transition">Diary</a>
                    <a href="#maps" class="hover:text-pink-500 transition">Maps</a>
                    <a href="#videos" class="hover:text-pink-500 transition">Vault</a>
                    <button onclick="toggleSettings()" class="text-pink-500 text-lg hover:scale-110 transition">âš™ï¸</button>
                </div>
            </div>
        </nav>

        <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white/95 dark:bg-slate-900/95 backdrop-blur-lg border-t border-pink-100 dark:border-slate-800 z-[45] pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <div class="flex justify-between items-center h-16 px-2 text-[10px] font-bold text-gray-400 dark:text-gray-500">
                <a href="#header-profil" class="flex flex-col items-center gap-1 w-1/6 active:text-pink-500 transition-all active:scale-95"><span class="text-xl">ğŸ‘¤</span>Profil</a>
                <a href="#gallery" class="flex flex-col items-center gap-1 w-1/6 active:text-pink-500 transition-all active:scale-95"><span class="text-xl">ğŸ“¸</span>Memo</a>
                <a href="#wishlist" class="flex flex-col items-center gap-1 w-1/6 active:text-pink-500 transition-all active:scale-95"><span class="text-xl">âœˆï¸</span>List</a>
                <a href="#diary" class="flex flex-col items-center gap-1 w-1/6 active:text-pink-500 transition-all active:scale-95"><span class="text-xl">ğŸ“–</span>Diary</a>
                <button onclick="toggleExtraMenu()" class="flex flex-col items-center gap-1 w-1/6 active:text-pink-500 relative transition-all active:scale-95"><span class="text-xl">ğŸ“²</span>Lainnya</button>
            </div>
        </nav>

        <div id="settingsPanel" class="hidden fixed top-0 left-0 h-screen w-full md:w-80 bg-white/95 dark:bg-slate-800/95 backdrop-blur-xl p-6 shadow-2xl z-[100] border-r border-pink-100 dark:border-slate-700 fade-in overflow-y-auto text-gray-700 dark:text-gray-200">
            <div class="flex justify-between items-center mb-8 border-b dark:border-slate-600 pb-4">
                <h3 class="font-bold text-xl">âš™ï¸ Pengaturan</h3>
                <button onclick="toggleSettings()" class="w-10 h-10 bg-red-100 dark:bg-slate-700 rounded-full flex items-center justify-center text-red-500 font-bold transition-all active:scale-95">âœ•</button>
            </div>
            
            <div class="space-y-6">
                <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-2xl border border-green-100 dark:border-green-800">
                    <label class="block text-[10px] text-green-600 dark:text-green-300 font-bold mb-2 uppercase tracking-wider">Ganti Lagu (Lokal)</label>
                    <input type="file" id="localMusicInput" accept="audio/*" onchange="changeLocalMusic(this)" class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    <button onclick="resetLocalMusic()" class="mt-2 text-[10px] text-red-500 font-bold underline transition-all active:scale-95">Reset ke Lagu Awal</button>
                </div>

                <div class="bg-indigo-50 dark:bg-indigo-900/30 p-4 rounded-2xl border border-indigo-100 dark:border-indigo-800">
                    <label class="block text-[10px] text-indigo-500 dark:text-indigo-300 font-bold mb-3 uppercase tracking-wider">Identitas & Kontak</label>
                    <div class="mb-3">
                        <label class="text-[10px] font-bold opacity-70">ğŸ‘¤ Pihak 1 (Cowok)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="nameP1Input" placeholder="Nama" class="w-1/3 p-2 rounded-lg text-xs bg-white dark:bg-slate-800 border dark:border-slate-600 focus:outline-none">
                            <input type="text" id="waP1Input" placeholder="628xxx" class="w-2/3 p-2 rounded-lg text-xs bg-white dark:bg-slate-800 border dark:border-slate-600 focus:outline-none">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="text-[10px] font-bold opacity-70">ğŸ‘¤ Pihak 2 (Cewek)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="nameP2Input" placeholder="Nama" class="w-1/3 p-2 rounded-lg text-xs bg-white dark:bg-slate-800 border dark:border-slate-600 focus:outline-none">
                            <input type="text" id="waP2Input" placeholder="628xxx" class="w-2/3 p-2 rounded-lg text-xs bg-white dark:bg-slate-800 border dark:border-slate-600 focus:outline-none">
                        </div>
                    </div>
                    <button onclick="updateContacts()" class="w-full bg-indigo-500 text-white text-xs font-bold py-2.5 rounded-xl shadow hover:bg-indigo-600 active:scale-95 transition">Simpan Identitas</button>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wider">Keamanan</label>
                    <div class="flex gap-2">
                        <input type="text" id="newPinInput" placeholder="PIN Baru" class="flex-1 p-3 bg-gray-50 dark:bg-slate-700 rounded-xl text-sm border border-gray-100 dark:border-slate-600 focus:outline-none">
                        <button onclick="updatePin()" class="bg-gray-800 dark:bg-slate-600 text-white text-xs font-bold px-4 rounded-xl transition-all active:scale-95">Ganti</button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wider">Tanggal Jadian</label>
                    <div class="flex gap-2 mb-2">
                        <input type="date" id="startDateInput" class="w-3/5 p-2 bg-gray-50 dark:bg-slate-700 rounded-xl text-sm border border-gray-100 dark:border-slate-600 dark:text-white">
                        <input type="time" id="startTimeInput" class="w-2/5 p-2 bg-gray-50 dark:bg-slate-700 rounded-xl text-sm border border-gray-100 dark:border-slate-600 dark:text-white">
                    </div>
                    <button onclick="updateDate()" class="w-full bg-pink-500 text-white text-xs font-bold py-2.5 rounded-xl shadow hover:bg-pink-600 active:scale-95 transition">Update Tanggal</button>
                </div>

                <div class="flex justify-between items-center bg-gray-100 dark:bg-slate-700 p-4 rounded-xl">
                    <span class="font-bold text-sm">Mode Gelap</span>
                    <button onclick="toggleDarkMode()" class="w-10 h-10 bg-white dark:bg-slate-600 rounded-full flex items-center justify-center text-xl transition shadow active:scale-95">ğŸŒ“</button>
                </div>
            </div>
        </div>

        <header id="header-profil" class="relative overflow-hidden">
            <div class="absolute top-0 left-0 w-64 h-64 bg-pink-200 dark:bg-slate-700 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
            <div class="absolute top-0 right-0 w-64 h-64 bg-purple-200 dark:bg-slate-800 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
            
            <div class="max-w-7xl mx-auto relative z-10 px-4">
                <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-8 md:gap-4 text-center">
                    <div class="order-1 flex flex-col items-center">
                        <div class="relative w-40 h-40 md:w-56 md:h-56 mb-4 group cursor-pointer float-anim" onclick="document.getElementById('uploadP1').click()">
                            <img id="imgP1" src="https://via.placeholder.com/200?text=Cowok" class="w-full h-full object-cover rounded-full border-[6px] border-white dark:border-slate-800 shadow-xl relative z-10">
                            <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-full opacity-0 group-hover:opacity-100 transition z-20 text-white text-xs font-bold backdrop-blur-[2px]">ğŸ“· GANTI</div>
                        </div>
                        <input type="file" id="uploadP1" class="hidden" accept="image/*" onchange="changeProfilePic(this, 'p1')">
                        <h2 id="nameP1" contenteditable="true" onblur="saveProfileText('p1', 'name', 'nameP1')" class="text-2xl font-bold text-gray-800 dark:text-white px-3 rounded-lg focus:bg-white dark:focus:bg-slate-800 outline-none">Asep</h2>
                        <p id="statusP1" contenteditable="true" onblur="saveProfileText('p1', 'status', 'statusP1')" class="text-sm font-medium text-gray-500 dark:text-gray-400 mt-1 italic px-2 focus:bg-white dark:focus:bg-slate-800 outline-none">The King ğŸ‘‘</p>
                    </div>

                    <div class="order-3 md:order-2 flex flex-col items-center justify-center">
                        <h2 class="text-xl font-bold text-pink-500 uppercase tracking-[0.3em] mb-4">Together Since</h2>
                        <div id="startDateDisplay" class="text-sm font-bold text-gray-400 dark:text-gray-500 mb-8 bg-white/60 dark:bg-slate-800/60 px-4 py-1 rounded-full shadow-sm">...</div>
                        <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md p-6 rounded-[2rem] shadow-2xl border-2 border-white dark:border-slate-700 w-full max-w-sm mx-auto transform hover:scale-105 transition duration-500 cursor-help" onclick="toggleSettings()">
                            <div id="loveTimer" class="grid grid-cols-2 gap-4 font-mono text-gray-700 dark:text-gray-300"></div>
                        </div>
                    </div>

                    <div class="order-2 md:order-3 flex flex-col items-center">
                        <div class="relative w-40 h-40 md:w-56 md:h-56 mb-4 group cursor-pointer float-anim-delay" onclick="document.getElementById('uploadP2').click()">
                            <img id="imgP2" src="https://via.placeholder.com/200?text=Cewek" class="w-full h-full object-cover rounded-full border-[6px] border-white dark:border-slate-800 shadow-xl relative z-10">
                            <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-full opacity-0 group-hover:opacity-100 transition z-20 text-white text-xs font-bold backdrop-blur-[2px]">ğŸ“· GANTI</div>
                        </div>
                        <input type="file" id="uploadP2" class="hidden" accept="image/*" onchange="changeProfilePic(this, 'p2')">
                        <h2 id="nameP2" contenteditable="true" onblur="saveProfileText('p2', 'name', 'nameP2')" class="text-2xl font-bold text-gray-800 dark:text-white px-3 rounded-lg focus:bg-white dark:focus:bg-slate-800 outline-none">Udel</h2>
                        <p id="statusP2" contenteditable="true" onblur="saveProfileText('p2', 'status', 'statusP2')" class="text-sm font-medium text-gray-500 dark:text-gray-400 mt-1 italic px-2 focus:bg-white dark:focus:bg-slate-800 outline-none">The Queen ğŸ‘‘</p>
                    </div>
                </div>
            </div>
        </header>
        
        <section id="gallery" class="py-20 px-4 max-w-7xl mx-auto w-full">
            <div class="flex flex-col md:flex-row items-center justify-between mb-12 gap-6">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Our Memories ğŸ“¸</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Simpan setiap momen manis kita di sini.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleSelectionMode()" id="btnSelectMode" class="bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 font-bold px-6 py-3 rounded-full shadow-md active:scale-95 transition">âœ“ Pilih</button>
                    <button onclick="deleteSelectedMemories()" id="btnDeleteSelected" class="hidden bg-red-500 text-white font-bold px-6 py-3 rounded-full shadow-md active:scale-95 transition">ğŸ—‘ï¸ Hapus (<span id="selectedCount">0</span>)</button>
                    <label class="bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white font-bold px-8 py-3 rounded-full shadow-lg shadow-pink-200 dark:shadow-none cursor-pointer flex items-center gap-2 transition transform hover:-translate-y-1 active:scale-95">
                        <span>+ Upload</span>
                        <input type="file" class="hidden" multiple accept="image/*" onchange="window.addPhotos(this)">
                    </label>
                </div>
            </div>
            <div id="photoGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
            <div id="emptyMsg" class="hidden text-center text-gray-400 dark:text-gray-500 mt-4 py-20 bg-white/50 dark:bg-slate-800/50 rounded-3xl border-2 border-dashed border-pink-200 dark:border-slate-700 flex flex-col items-center justify-center">
                <span class="text-5xl mb-4 opacity-50">ğŸ“·</span>
                <p>Belum ada foto. Yuk upload momen pertamamu!</p>
            </div>
        </section>

        <section id="wishlist" class="py-20 px-4 bg-pink-50 dark:bg-slate-900 border-t border-pink-100 dark:border-slate-800 transition-colors duration-500 rounded-t-[3rem] mt-10">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">Bucket List âœˆï¸</h2>
                    <p class="text-gray-500 dark:text-gray-400">Mimpi-mimpi kita yang harus diwujudkan.</p>
                </div>
                <div class="md:col-span-2">
                    <div class="flex gap-4 mb-6 text-sm font-bold overflow-x-auto pb-2 no-scrollbar">
                        <span class="bg-white dark:bg-slate-800 px-5 py-2.5 rounded-full shadow-sm border border-pink-100 dark:border-slate-700 text-pink-600 dark:text-pink-400 flex items-center gap-2 whitespace-nowrap">ğŸ¯ Total: <span id="totalWishes">0</span></span>
                        <span class="bg-white dark:bg-slate-800 px-5 py-2.5 rounded-full shadow-sm border border-green-100 dark:border-slate-700 text-green-600 dark:text-green-400 flex items-center gap-2 whitespace-nowrap">âœ… Sudah: <span id="completedWishes">0</span></span>
                    </div>
                    <div id="wishlistGrid" class="flex flex-col gap-4"></div>
                    <div id="noWishMsg" class="hidden text-center text-gray-400 dark:text-gray-500 py-20"><span class="text-4xl">ğŸ—ºï¸</span><br>Belum ada rencana.</div>
                </div>
                
                <div class="fixed md:static bottom-20 left-0 w-full px-4 z-30 md:z-0 md:w-auto">
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] border border-gray-100 dark:border-slate-700 max-w-xl mx-auto flex gap-2 items-center">
                        <div class="flex-1 flex flex-col gap-2">
                            <input type="text" id="wishName" placeholder="Rencana baru..." class="w-full p-3 bg-gray-50 dark:bg-slate-700 rounded-xl text-sm outline-none font-bold">
                            <div class="flex gap-2">
                                <input type="number" id="wishCost" placeholder="Rp 0" class="w-1/2 p-2 bg-gray-50 dark:bg-slate-700 rounded-lg text-xs outline-none">
                                <input type="url" id="wishLink" placeholder="Link (Opsional)" class="w-1/2 p-2 bg-gray-50 dark:bg-slate-700 rounded-lg text-xs outline-none">
                            </div>
                        </div>
                        <button onclick="window.addWish()" class="bg-pink-500 hover:bg-pink-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center font-bold text-xl transition transform active:scale-95">â•</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="diary" class="py-20 px-2 md:px-4 bg-white dark:bg-slate-900 border-t border-pink-50 dark:border-slate-800 transition-colors duration-500">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">Shared Diary ğŸ“–</h2>
                    <p class="text-gray-500 dark:text-gray-400">Tulis cerita, perasaan, atau hal lucu hari ini.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                    <div class="lg:col-span-4 h-fit space-y-6">
                        <div class="bg-white dark:bg-slate-800 p-5 rounded-3xl shadow-lg border border-pink-100 dark:border-slate-700">
                            <h4 class="text-sm font-bold text-gray-600 dark:text-gray-300 mb-3 text-center uppercase tracking-wider">Mood Meter</h4>
                            <div class="relative w-full h-48"><canvas id="moodChart"></canvas></div>
                            <p class="text-xs text-center text-gray-400 dark:text-gray-500 mt-2 italic" id="moodSummary">Belum ada data...</p>
                        </div>
                        <div class="bg-gradient-to-br from-pink-50 to-white dark:from-slate-800 dark:to-slate-900 p-4 rounded-3xl shadow-xl border border-pink-100 dark:border-slate-700">
                            <input type="text" id="diaryTitle" placeholder="Judul momen..." class="w-full mb-4 p-4 rounded-xl border border-gray-100 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300 dark:text-white font-bold text-gray-700">
                            <div class="flex gap-3 mb-4">
                                <input type="date" id="diaryDate" class="w-2/3 p-3 rounded-xl border border-gray-100 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm text-sm">
                                <select id="diaryMood" class="w-1/3 p-3 rounded-xl border border-gray-100 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm text-2xl text-center">
                                    <option>ğŸ¥°</option><option>ğŸ˜‚</option><option>ğŸ˜­</option><option>ğŸ˜¡</option><option>ğŸ¥³</option><option>ğŸ˜´</option>
                                </select>
                            </div>
                            <textarea id="diaryContent" rows="4" placeholder="Ceritain dong..." class="w-full mb-4 p-4 rounded-xl border border-gray-100 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300 dark:text-white resize-none text-gray-600"></textarea>
                            <button onclick="window.addDiary()" class="w-full bg-gray-800 dark:bg-slate-600 hover:bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                                <span>âœ¨ Simpan Diary</span>
                            </button>
                        </div>
                    </div>
                    <div class="lg:col-span-8 space-y-6" id="diaryList">
                        <div id="noDiaryMsg" class="text-center text-gray-400 dark:text-gray-500 py-24 bg-gray-50 dark:bg-slate-800 rounded-3xl border-2 border-dashed border-gray-200 dark:border-slate-700 flex flex-col items-center justify-center"><span class="text-5xl mb-4 opacity-50">ğŸ“</span>Belum ada cerita.</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="maps" class="py-20 px-4 bg-blue-50 dark:bg-slate-800 border-t border-blue-100 dark:border-slate-700 transition-colors duration-500">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-10">
                    <h2 class="text-4xl font-bold text-blue-800 dark:text-blue-300 mb-2">Our Journey ğŸ—ºï¸</h2>
                    <p class="text-blue-500 dark:text-blue-400">Klik di peta untuk menandai tempat kenangan kita.</p>
                </div>
                <div class="bg-white dark:bg-slate-700 p-2 rounded-3xl shadow-xl border-4 border-white dark:border-slate-600 h-[500px] relative overflow-hidden group">
                    <div id="map" class="w-full h-full z-10"></div>
                    <div class="absolute bottom-6 left-6 z-20 bg-white/90 dark:bg-slate-800/90 backdrop-blur px-4 py-2 rounded-lg shadow text-xs font-bold text-gray-600 dark:text-gray-300">ğŸ‘† Klik peta untuk tambah lokasi</div>
                </div>
            </div>
        </section>

        <section id="videos" class="py-20 px-4 bg-white dark:bg-slate-800 border-t border-gray-100 dark:border-slate-700 pb-40 transition-colors duration-500">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-3xl font-bold text-center text-gray-800 dark:text-white mb-10">Video & Link Vault ğŸ”—</h2>
                <div class="max-w-3xl mx-auto bg-gray-50 dark:bg-slate-700 p-2 pl-4 rounded-full shadow-inner mb-16 flex flex-col md:flex-row gap-2 border border-gray-200 dark:border-slate-600">
                    <input type="text" id="videoUrl" placeholder="Tempel Link (YouTube/TikTok/IG)..." class="flex-1 bg-transparent p-2 focus:outline-none text-gray-700 dark:text-white">
                    <div class="h-8 w-px bg-gray-300 dark:bg-slate-500 my-auto hidden md:block"></div>
                    <input type="text" id="videoCaption" placeholder="Judul / Keterangan" class="md:w-1/3 bg-transparent p-2 focus:outline-none text-gray-700 dark:text-white">
                    <button onclick="window.addVideo()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-8 py-3 rounded-full shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 shrink-0">ğŸ’¾ Simpan</button>
                </div>
                <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                <div id="noVideoMsg" class="hidden text-center text-gray-400 dark:text-gray-500 py-20 bg-gray-50 dark:bg-slate-700 rounded-3xl border-2 border-dashed border-gray-200 dark:border-slate-600 flex flex-col items-center justify-center"><span class="text-4xl mb-3 opacity-50">ğŸ”—</span>Belum ada link tersimpan.</div>
            </div>
        </section>

        <footer class="bg-white dark:bg-slate-900 py-2 text-center text-gray-400 dark:text-gray-500 text-[10px] border-t dark:border-slate-800 transition-colors duration-500">
            <p>Made with ğŸ’– by Asep & Udel</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdB_cqR4QTYiUx9ik1ruZyXq88HqSfPVk",
            authDomain: "lovestory-kita.firebaseapp.com",
            databaseURL: "https://lovestory-kita-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lovestory-kita",
            storageBucket: "lovestory-kita.firebasestorage.app",
            messagingSenderId: "1076512835872",
            appId: "1:1076512835872:web:c0571708f387ac164cef45",
            measurementId: "G-PKE0C3QKD5"
        };

        const imgbbAPIKey = "45313df89cb1e741284dbeb8cbfba7f5"; 
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- VARIABEL GLOBAL ---
        let correctPin = "1234";
        let startRelationshipDate = new Date();
        let contactP1 = "6285883278505"; 
        let contactP2 = "6281284711123"; 
        let nameP1 = "Asep";
        let nameP2 = "Udel";
        let tempDeletePath = null;
        let isMusicPlaying = false;
        let moodChartInstance = null;
        let map = null;
        let tempMapLatLng = null;

        let selectionMode = false;
        let selectedMemories = new Set();
        
        // Variabel Gallery & Slideshow
        let currentGalleryImages = []; 
        let currentImageIndex = 0;     
        let currentAlbum = 'All';      

        // --- 1. SYSTEM UTAMA & MUSIK ---
        window.enterApp = function() {
            const ws = document.getElementById('welcomeScreen');
            ws.style.opacity = '0';
            setTimeout(() => { ws.style.display = 'none'; }, 1000);
            document.getElementById('pinOverlay').classList.remove('hidden');
            
            const audio = document.getElementById('bgAudio');
            const localSong = localStorage.getItem('localSong');
            if(localSong) audio.src = localSong;
            
            audio.volume = 0.5; 
            audio.play().then(() => {
                isMusicPlaying = true;
                document.getElementById('musicBtn').classList.remove('hidden');
                document.getElementById('musicWidget').classList.remove('hidden');
                document.getElementById('musicWidget').classList.add('flex');
            }).catch(e => console.log("Gagal Play Otomatis:", e));
            setTimeout(initMap, 2000);
        }

        window.toggleMusic = function() {
            const audio = document.getElementById('bgAudio');
            const icon = document.getElementById('musicIcon');
            if (isMusicPlaying) { audio.pause(); icon.innerHTML = 'ğŸ”‡'; icon.classList.remove('animate-spin-slow'); } 
            else { audio.play(); icon.innerHTML = 'ğŸµ'; icon.classList.add('animate-spin-slow'); }
            isMusicPlaying = !isMusicPlaying;
        }

        window.changeLocalMusic = function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    localStorage.setItem('localSong', e.target.result);
                    const audio = document.getElementById('bgAudio');
                    audio.src = e.target.result;
                    audio.play();
                    showPopup('Berhasil!', 'Lagu diganti di HP ini aja ğŸµ');
                } catch(err) {
                    showPopup('Gagal', 'File lagu terlalu besar!', 'error');
                }
            }
            reader.readAsDataURL(file);
        }

        window.resetLocalMusic = function() {
            localStorage.removeItem('localSong');
            document.getElementById('bgAudio').src = "Yung Kai - Blue.mp3";
            showPopup('Reset', 'Balik ke lagu default.', 'success');
        }

        window.toggleDarkMode = function() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');

        const sections = document.querySelectorAll('section');
        const navItems = document.querySelectorAll('.nav-item');
        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (scrollY >= sectionTop - 200) current = section.getAttribute('id');
            });
            navItems.forEach(li => {
                li.classList.remove('nav-active');
                if (li.getAttribute('id') === `nav-${current}`) li.classList.add('nav-active');
            });
        });

        // --- 2. FITUR SLIDESHOW (LIGHTBOX) ---
        window.openLightbox = function(src) {
            currentImageIndex = currentGalleryImages.findIndex(img => img.url === src);
            updateLightboxImage();
            
            const lb = document.getElementById('lightbox');
            lb.classList.remove('hidden');
            setTimeout(() => lb.classList.remove('opacity-0'), 10);
        }
        
        window.updateLightboxImage = function() {
            if(currentGalleryImages.length > 0 && currentGalleryImages[currentImageIndex]) {
                const img = document.getElementById('lightboxImg');
                img.src = currentGalleryImages[currentImageIndex].url;
            }
        }
        
        window.prevImage = function(e) {
            e.stopPropagation();
            if(currentGalleryImages.length === 0) return;
            currentImageIndex = (currentImageIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length;
            updateLightboxImage();
        }
        
        window.nextImage = function(e) {
            e.stopPropagation();
            if(currentGalleryImages.length === 0) return;
            currentImageIndex = (currentImageIndex + 1) % currentGalleryImages.length;
            updateLightboxImage();
        }

        window.closeLightbox = function() {
            const lb = document.getElementById('lightbox');
            lb.classList.add('opacity-0');
            setTimeout(() => { lb.classList.add('hidden'); document.getElementById('lightboxImg').src = ''; }, 300);
        }
        
        window.toggleExtraMenu = function() {
            const menu = document.getElementById('extraMenu');
            menu.classList.toggle('hidden');
        }

        // --- 3. HELPER & POPUP ---
        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPIKey}`, { method: "POST", body: formData });
            const result = await response.json();
            if (result.success) return result.data.url;
            throw new Error("Gagal upload");
        }

        window.showPopup = function(title, message, type = 'success', confirmAction = null) {
            const popup = document.getElementById('customPopup');
            const titleEl = document.getElementById('popupTitle');
            const msgEl = document.getElementById('popupMessage');
            const icon = document.getElementById('popupIcon');
            const actions = document.getElementById('popupActions');

            titleEl.innerText = title;
            msgEl.innerText = message;
            actions.innerHTML = ''; 

            if (type === 'success') { icon.innerHTML = 'ğŸ‰'; titleEl.className = 'text-2xl font-bold text-pink-600 mb-2 dark:text-pink-400'; } 
            else if (type === 'error') { icon.innerHTML = 'ğŸ¥º'; titleEl.className = 'text-2xl font-bold text-red-500 mb-2'; } 
            else if (type === 'loading') { icon.innerHTML = 'â³'; titleEl.className = 'text-2xl font-bold text-blue-500 mb-2'; }
            else if (type === 'confirm') { icon.innerHTML = 'ğŸ¤”'; titleEl.className = 'text-2xl font-bold text-gray-700 dark:text-gray-300 mb-2'; }

            if (type === 'confirm') {
                const btnCancel = document.createElement('button');
                btnCancel.className = "flex-1 bg-gray-100 dark:bg-slate-600 text-gray-500 dark:text-gray-400 py-3 rounded-xl font-bold transition-all active:scale-95";
                btnCancel.innerText = "Batal";
                btnCancel.onclick = window.closePopup;
                
                const btnOk = document.createElement('button');
                btnOk.className = "flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold shadow-lg transition-all active:scale-95";
                btnOk.innerText = "Ya, Lanjut";
                btnOk.onclick = () => { confirmAction(); window.closePopup(); };
                
                actions.appendChild(btnCancel);
                actions.appendChild(btnOk);
            } else {
                const btnOk = document.createElement('button');
                btnOk.className = "w-full bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95";
                btnOk.innerText = "Oke";
                btnOk.onclick = window.closePopup;
                actions.appendChild(btnOk);
            }

            popup.classList.remove('hidden');
            setTimeout(() => { popup.classList.remove('opacity-0'); }, 10);
        }

        window.closePopup = function() {
            const popup = document.getElementById('customPopup');
            popup.classList.add('opacity-0');
            setTimeout(() => { popup.classList.add('hidden'); }, 300);
        }

        // --- NEW: CUSTOM INPUT POPUP (REPLACEMENT FOR PROMPT) ---
        window.showInputPopup = function(title, callback) {
            const popup = document.getElementById('customInputPopup');
            document.getElementById('customInputTitle').innerText = title;
            const field = document.getElementById('customInputField');
            field.value = '';
            popup.classList.remove('hidden');
            setTimeout(() => popup.classList.remove('opacity-0'), 10);
            field.focus();

            const btn = document.getElementById('customInputConfirmBtn');
            // Remove old listeners to avoid multiple firings
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.onclick = () => {
                if(field.value.trim()) {
                    callback(field.value.trim());
                    window.closeCustomInput();
                } else {
                    field.classList.add('ring-2', 'ring-red-500');
                    setTimeout(()=>field.classList.remove('ring-2', 'ring-red-500'), 500);
                }
            };
        }

        window.closeCustomInput = function() {
            const popup = document.getElementById('customInputPopup');
            popup.classList.add('opacity-0');
            setTimeout(() => { popup.classList.add('hidden'); }, 300);
        }

        // --- 4. GOOGLE MAPS IMPLEMENTATION ---
        function initMap() {
            if(map) return;
            map = L.map('map').setView([-6.2088, 106.8456], 12);
            
            // Menggunakan HTTPS agar tidak diblokir WebView Android modern
            L.tileLayer('https://mt0.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
                attribution: 'Google Maps',
                maxZoom: 20,
                subdomains:['mt0','mt1','mt2','mt3']
            }).addTo(map);

            map.on('click', function(e) {
                tempMapLatLng = e.latlng;
                const modal = document.getElementById('mapInputPopup');
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); }, 10);
                document.getElementById('mapNoteInput').focus();
            });

            listenToData('locations', (data) => {
                if(!data) return;
                map.eachLayer((layer) => { if(layer instanceof L.Marker) { map.removeLayer(layer); } });
                Object.values(data).forEach(loc => {
                    const marker = L.marker([loc.lat, loc.lng]).addTo(map);
                    marker.bindPopup(`<b>${loc.note}</b><br><button onclick="askDelete('locations/${loc.id}')" style="color:red; margin-top:5px; font-size:10px;">Hapus Lokasi</button>`);
                });
            });
        }

        window.closeMapInput = function() {
            const modal = document.getElementById('mapInputPopup');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
            document.getElementById('mapNoteInput').value = '';
        }

        window.confirmAddMap = function() {
            const note = document.getElementById('mapNoteInput').value;
            if(note && tempMapLatLng) {
                const id = Date.now().toString();
                writeData(`locations/${id}`, { id: id, lat: tempMapLatLng.lat, lng: tempMapLatLng.lng, note: note });
                window.closeMapInput();
                window.showPopup("Ditandai!", "Lokasi baru ditambahkan di peta ğŸ“");
            }
        }

        // --- 5. LOGIKA IDENTITAS & PROFILE ---
        window.showIdentityPopup = function() {
            document.getElementById('btnNameP1').innerText = nameP1;
            document.getElementById('btnNameP2').innerText = nameP2;
            const popup = document.getElementById('identityPopup');
            popup.classList.remove('hidden');
            setTimeout(() => { popup.classList.remove('opacity-0'); }, 10);
        }

        window.closeIdentityPopup = function() {
            const popup = document.getElementById('identityPopup');
            popup.classList.add('opacity-0');
            setTimeout(() => { popup.classList.add('hidden'); }, 300);
        }

        window.processMissYou = function(role) {
            window.closeIdentityPopup();
            
            // Logic Notifikasi Native (Android)
            if (typeof Android !== 'undefined') {
                Android.showNotification("Ada yang kangen! â¤ï¸", `Si ${role === 'p1' ? nameP1 : nameP2} lagi kangen berat nih. Buruan chat!`);
                Android.showToast("Notifikasi Kangen terkirim ke HP! ğŸ””");
            } else {
                // Fallback kalau dibuka di browser biasa
                window.showPopup("Kangen Terkirim!", "Pesan kangen virtual sudah dikirim (Simulasi).");
            }
        }

        window.toggleSettings = function() { document.getElementById('settingsPanel').classList.toggle('hidden'); }
        
        window.updatePin = function() {
            const newPin = document.getElementById('newPinInput').value;
            if (newPin.length >= 4) { set(ref(db, 'config/pin'), newPin); showPopup('Sukses!', 'PIN diganti!'); } 
            else { showPopup('Gagal', 'Minimal 4 karakter', 'error'); }
        }
        
        window.updateDate = function() {
            const d = document.getElementById('startDateInput').value;
            const t = document.getElementById('startTimeInput').value || "00:00";
            if(d) { set(ref(db, 'config/startDate'), new Date(`${d}T${t}`).toISOString()); showPopup('Sukses!', 'Tanggal update!'); }
        }

        window.updateContacts = function() {
            const name1 = document.getElementById('nameP1Input').value;
            const wa1 = document.getElementById('waP1Input').value;
            const name2 = document.getElementById('nameP2Input').value;
            const wa2 = document.getElementById('waP2Input').value;

            if(name1) set(ref(db, 'profiles/p1/name'), name1);
            if(wa1) set(ref(db, 'config/waP1'), wa1);
            if(name2) set(ref(db, 'profiles/p2/name'), name2);
            if(wa2) set(ref(db, 'config/waP2'), wa2);

            showPopup('Disimpan!', 'Identitas & Kontak berhasil update! ğŸ’–');
        }

        function listenToData(path, callback) { onValue(ref(db, path), (snapshot) => { callback(snapshot.val()); }); }
        function writeData(path, data) { set(ref(db, path), data); }

        // --- 6. DATA LISTENER (REALTIME UPDATES) ---
        onValue(ref(db, 'config'), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                if (data.pin) correctPin = data.pin;
                if (data.waP1) { contactP1 = data.waP1; document.getElementById('waP1Input').value = data.waP1; }
                if (data.waP2) { contactP2 = data.waP2; document.getElementById('waP2Input').value = data.waP2; }
                if (data.startDate) {
                    startRelationshipDate = new Date(data.startDate);
                    document.getElementById('startDateDisplay').innerText = new Date(data.startDate).toLocaleDateString('id-ID', { dateStyle: 'full' });
                    const isoDate = new Date(data.startDate).toISOString();
                    document.getElementById('startDateInput').value = isoDate.split('T')[0];
                    document.getElementById('startTimeInput').value = isoDate.split('T')[1].substring(0,5);
                }
            }
        });

        listenToData('profiles', (data) => {
            if (data) {
                if (data.p1) { nameP1 = data.p1.name || "Cowok"; document.getElementById('nameP1').innerText = nameP1; document.getElementById('statusP1').innerText = data.p1.status || "Status..."; document.getElementById('nameP1Input').value = nameP1; if (data.p1.image) document.getElementById('imgP1').src = data.p1.image; }
                if (data.p2) { nameP2 = data.p2.name || "Cewek"; document.getElementById('nameP2').innerText = nameP2; document.getElementById('statusP2').innerText = data.p2.status || "Status..."; document.getElementById('nameP2Input').value = nameP2; if (data.p2.image) document.getElementById('imgP2').src = data.p2.image; }
                document.getElementById('btnNameP1').innerText = nameP1;
                document.getElementById('btnNameP2').innerText = nameP2;
            }
        });

        setInterval(() => {
            const now = new Date();
            const diff = now - startRelationshipDate;
            if (diff >= 0) {
                const years = Math.floor(diff / (1000 * 60 * 60 * 24 * 365));
                const days = Math.floor((diff % (1000 * 60 * 60 * 24 * 365)) / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('loveTimer').innerHTML = `<div class="flex flex-col items-center bg-pink-50 dark:bg-slate-700 rounded-xl py-2"><span class="text-3xl font-black text-pink-600 dark:text-pink-400">${years}</span><span class="text-[10px] text-pink-400 dark:text-pink-300 uppercase font-bold">Tahun</span></div><div class="flex flex-col items-center bg-pink-50 dark:bg-slate-700 rounded-xl py-2"><span class="text-3xl font-black text-pink-600 dark:text-pink-400">${days}</span><span class="text-[10px] text-pink-400 dark:text-pink-300 uppercase font-bold">Hari</span></div><div class="flex flex-col items-center bg-gray-50 dark:bg-slate-800 rounded-xl py-2 border border-gray-100 dark:border-slate-600"><span class="text-2xl font-bold text-gray-600 dark:text-gray-300">${hours}</span><span class="text-[10px] text-gray-400 dark:text-gray-500 uppercase font-bold">Jam</span></div><div class="flex flex-col items-center bg-gray-50 dark:bg-slate-800 rounded-xl py-2 border border-gray-100 dark:border-slate-600"><span class="text-2xl font-bold text-gray-600 dark:text-gray-300">${minutes}</span><span class="text-[10px] text-gray-400 dark:text-gray-500 uppercase font-bold">Menit</span></div><div class="col-span-2 text-center text-xs text-pink-300 font-mono mt-1 animate-pulse">Running: ${seconds} seconds</div>`;
            }
        }, 1000);

        window.checkPin = function() {
            if (document.getElementById('pinInput').value === correctPin) {
                document.getElementById('pinOverlay').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('opacity-0');
            } else { showPopup('Salah!', 'PIN salah nih. Coba lagi! ğŸ¤”', 'error'); document.getElementById('pinInput').value = ''; }
        }

        window.saveProfileText = function(u, f, id) { set(ref(db, `profiles/${u}/${f}`), document.getElementById(id).innerText); }
        window.changeProfilePic = async function(input, u) {
            if (input.files && input.files[0]) {
                showPopup('Upload...', 'Lagi kirim ke ImgBB...', 'loading');
                try {
                    const url = await uploadToImgBB(input.files[0]);
                    await set(ref(db, `profiles/${u}/image`), url);
                    showPopup('Berhasil!', 'Foto profil ganti! ğŸ˜');
                } catch (e) { showPopup('Gagal', 'Cek koneksi/API Key', 'error'); }
            }
        }

        // --- 7. GALERI LOGIC (REVISI LENGKAP) ---
        listenToData('gallery', (data) => {
            const allPhotos = data ? Object.values(data).reverse() : [];
            renderGallery(allPhotos);
        });

        function renderGallery(photos) {
            const grid = document.getElementById('photoGrid');
            
            // Logic Tab Album
            if (!document.getElementById('albumControls')) {
                const albumDiv = document.createElement('div');
                albumDiv.id = 'albumControls';
                albumDiv.className = "flex gap-2 overflow-x-auto pb-4 mb-4 no-scrollbar";
                grid.parentNode.insertBefore(albumDiv, grid);
            }

            const uniqueAlbums = [...new Set(photos.map(p => p.album || 'Lainnya'))];
            const albumDiv = document.getElementById('albumControls');
            
            albumDiv.innerHTML = `
                <button onclick="switchAlbum('All')" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition shadow-sm ${currentAlbum === 'All' ? 'bg-pink-500 text-white shadow-pink-300' : 'bg-white text-gray-500 border border-gray-200'}">ğŸ“‚ Semua</button>
                <button onclick="createNewAlbum()" class="px-4 py-2 rounded-full text-xs font-bold bg-white text-pink-500 border border-pink-200 whitespace-nowrap hover:bg-pink-50 transition">+ Buat Album</button>
            `;

            uniqueAlbums.forEach(alb => {
                if(alb === 'Lainnya') return; 
                const btn = document.createElement('button');
                btn.innerText = `ğŸ“ ${alb}`;
                btn.onclick = () => switchAlbum(alb);
                btn.className = `px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition shadow-sm ${currentAlbum === alb ? 'bg-pink-500 text-white shadow-pink-300' : 'bg-white text-gray-500 border border-gray-200'}`;
                albumDiv.appendChild(btn);
            });

            const filteredPhotos = currentAlbum === 'All' ? photos : photos.filter(img => img.album === currentAlbum);
            
            // Update Slideshow Data
            currentGalleryImages = filteredPhotos;

            grid.innerHTML = '';
            
            if (filteredPhotos.length === 0) {
                document.getElementById('emptyMsg').classList.remove('hidden');
                document.querySelector('#emptyMsg p').innerText = currentAlbum === 'All' ? "Belum ada foto. Upload dong!" : `Album '${currentAlbum}' masih kosong.`;
            } else {
                document.getElementById('emptyMsg').classList.add('hidden');
                
                filteredPhotos.forEach((ph, index) => { 
                    const isSelected = selectedMemories.has(ph.id);
                    const d = document.createElement('div');
                    
                    d.className = `group relative aspect-square overflow-hidden rounded-2xl shadow-sm hover:shadow-xl transition duration-300 border-2 ${isSelected ? 'border-pink-500' : 'border-transparent'}`;
                    
                    d.innerHTML = `
                        <img src="${ph.url}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110" loading="lazy">
                        <div class="absolute inset-0 bg-black/10 group-hover:bg-black/20 transition"></div>
                        <div class="absolute top-2 right-2 z-20 ${selectionMode ? 'block' : 'hidden'}">
                             <div class="w-6 h-6 rounded-full border-2 border-white ${isSelected ? 'bg-pink-500' : 'bg-gray-400/50'} flex items-center justify-center text-white text-xs shadow-sm">âœ“</div>
                        </div>
                    `;
                    
                    d.onclick = () => {
                        if (selectionMode) {
                            if (selectedMemories.has(ph.id)) selectedMemories.delete(ph.id);
                            else selectedMemories.add(ph.id);
                            renderGallery(photos); 
                            document.getElementById('selectedCount').innerText = selectedMemories.size;
                        } else {
                            currentImageIndex = index;
                            updateLightboxImage();
                            const lb = document.getElementById('lightbox');
                            lb.classList.remove('hidden');
                            setTimeout(() => lb.classList.remove('opacity-0'), 10);
                        }
                    };
                    grid.appendChild(d);
                });
            }
        }

        window.switchAlbum = function(albumName) {
            currentAlbum = albumName;
            listenToData('gallery', (data) => {
                const allPhotos = data ? Object.values(data).reverse() : [];
                renderGallery(allPhotos);
            });
        }

        window.createNewAlbum = function() {
            // Ganti Prompt dengan Custom Popup
            window.showInputPopup("âœ¨ Nama Album Baru:", (name) => {
                currentAlbum = name;
                showPopup('Album Siap!', `Sekarang upload foto buat album: ${name} ğŸ“¸`);
                switchAlbum(name);
            });
        }

        window.addPhotos = async function(input) {
            if (input.files && input.files.length > 0) {
                showPopup('Sabar ya...', `Lagi upload ${input.files.length} foto ke Album: ${currentAlbum === 'All' ? 'Lainnya' : currentAlbum}...`, 'loading');
                let successCount = 0;
                try {
                    for (let i = 0; i < input.files.length; i++) {
                        const file = input.files[i];
                        const url = await uploadToImgBB(file); 
                        const id = Date.now() + Math.random().toString().slice(2,5);
                        
                        await set(ref(db, `gallery/${id}`), { 
                            url: url, 
                            id: id,
                            album: currentAlbum === 'All' ? 'Lainnya' : currentAlbum,
                            timestamp: Date.now()
                        });
                        successCount++;
                    }
                    showPopup('Berhasil!', `${successCount} Foto berhasil disimpan! ğŸ‰`);
                } catch (e) { 
                    console.error(e);
                    showPopup('Yah gagal...', 'Cek koneksi internet kamu ya.', 'error'); 
                }
                input.value = '';
            }
        }

        window.toggleSelectionMode = function() {
            selectionMode = !selectionMode;
            selectedMemories.clear();
            document.getElementById('selectedCount').innerText = '0';
            
            const btn = document.getElementById('btnSelectMode');
            const delBtn = document.getElementById('btnDeleteSelected');
            
            if (selectionMode) {
                btn.innerHTML = 'âœ• Batal';
                btn.className = "bg-red-100 text-red-500 font-bold px-6 py-3 rounded-full shadow-md active:scale-95 transition";
                delBtn.classList.remove('hidden');
            } else {
                btn.innerHTML = 'âœ“ Pilih';
                btn.className = "bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 font-bold px-6 py-3 rounded-full shadow-md active:scale-95 transition";
                delBtn.classList.add('hidden');
            }
            listenToData('gallery', (data) => { }); 
        }

        window.deleteSelectedMemories = function() {
            if (selectedMemories.size === 0) return showPopup('Ups', 'Pilih foto dulu dong!', 'error');
            
            window.showPopup('Hapus Banyak?', `Yakin mau hapus ${selectedMemories.size} foto?`, 'confirm', () => {
                const updates = {};
                selectedMemories.forEach(id => {
                    updates[`gallery/${id}`] = null;
                });
                
                update(ref(db), updates).then(() => {
                    showPopup('Terhapus!', 'Foto-foto terpilih sudah dihapus.');
                    toggleSelectionMode();
                }).catch(e => showPopup('Gagal', 'Error hapus data.', 'error'));
            });
        }

        window.askDelete = function(path) {
            tempDeletePath = path;
            window.showPopup('Hapus Kenangan?', 'Data ini bakal hilang selamanya lho...', 'confirm', () => {
                 window.executeDelete();
            });
        }

        window.executeDelete = function() {
            if (tempDeletePath) {
                remove(ref(db, tempDeletePath))
                    .then(() => { setTimeout(() => showPopup('Terhapus!', 'Kenangan sudah dihapus ğŸƒ'), 350); })
                    .catch(() => { showPopup('Ups!', 'Gagal menghapus.', 'error'); });
            }
        }

        // --- 8. DIARY LOGIC (REVISI RENDER) ---
        function updateMoodChart(diaryData) {
            const ctx = document.getElementById('moodChart').getContext('2d');
            const moodCounts = { 'ğŸ¥°':0, 'ğŸ˜‚':0, 'ğŸ˜­':0, 'ğŸ˜¡':0, 'ğŸ¥³':0, 'ğŸ˜´':0 };
            let total = 0;
            if (diaryData) { Object.values(diaryData).forEach(entry => { if(moodCounts[entry.mood] !== undefined) moodCounts[entry.mood]++; total++; }); }
            const summary = document.getElementById('moodSummary');
            if(total > 0) {
                const maxMood = Object.keys(moodCounts).reduce((a, b) => moodCounts[a] > moodCounts[b] ? a : b);
                summary.innerText = `Mood dominan: ${maxMood} (Total ${total})`;
            } else { summary.innerText = "Belum ada data cukup..."; }
            const data = {
                labels: ['Love', 'Lucu', 'Sedih', 'Marah', 'Party', 'Tidur'],
                datasets: [{ data: [moodCounts['ğŸ¥°'], moodCounts['ğŸ˜‚'], moodCounts['ğŸ˜­'], moodCounts['ğŸ˜¡'], moodCounts['ğŸ¥³'], moodCounts['ğŸ˜´']], backgroundColor: ['#f472b6', '#fbbf24', '#60a5fa', '#f87171', '#a78bfa', '#9ca3af'], borderWidth: 0 }]
            };
            if (moodChartInstance) { moodChartInstance.data = data; moodChartInstance.update(); } 
            else { moodChartInstance = new Chart(ctx, { type: 'doughnut', data: data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
        }

        listenToData('diary', (data) => {
            const l = document.getElementById('diaryList'); 
            if(!l) return;
            l.innerHTML = ''; 
            const d = data ? Object.values(data).sort((a,b) => (b.timestamp||0)-(a.timestamp||0)) : [];
            updateMoodChart(data); 

            if(d.length===0) {
                document.getElementById('noDiaryMsg').style.display = 'flex';
            } else {
                document.getElementById('noDiaryMsg').style.display = 'none';
                d.forEach(entry => {
                    const c = document.createElement('div');
                    c.className = "bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-pink-50 dark:border-slate-700 mb-4 fade-in";
                    c.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-lg text-gray-800 dark:text-white">${entry.title || 'Tanpa Judul'}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-0.5 rounded-full font-bold">ğŸ“… ${entry.date}</span>
                                    <span class="text-lg">${entry.mood}</span>
                                </div>
                            </div>
                            <button onclick="askDelete('diary/${entry.id}')" class="text-gray-300 hover:text-red-500 transition p-2">ğŸ—‘ï¸</button>
                        </div>
                        <p class="text-gray-600 dark:text-gray-300 text-sm whitespace-pre-line leading-relaxed border-l-2 border-pink-200 pl-3 mt-2">${entry.content}</p>
                    `;
                    l.appendChild(c);
                });
            }
        });

        window.addDiary = function() {
            const t = document.getElementById('diaryTitle').value, c = document.getElementById('diaryContent').value;
            if (!t || !c) return showPopup('Eits!', 'Judul & Isi wajib diisi!', 'error');
            const id = Date.now().toString();
            writeData(`diary/${id}`, { id, title: t, date: document.getElementById('diaryDate').value, mood: document.getElementById('diaryMood').value, content: c, timestamp: Date.now() });
            document.getElementById('diaryTitle').value=''; document.getElementById('diaryContent').value=''; showPopup('Tersimpan!', 'Diary baru! âœ¨');
        }

        // --- 9. BUCKET LIST LOGIC ---
        listenToData('wishlist', (data) => {
            const g = document.getElementById('wishlistGrid');
            g.innerHTML = '';
            // Ganti CSS agar tidak ketutup (Padding bawah)
            g.className = "flex flex-col gap-4 pb-24"; 

            const w = data ? Object.values(data).sort((a,b)=>b.timestamp-a.timestamp) : [];
            document.getElementById('totalWishes').innerText = w.length;
            document.getElementById('completedWishes').innerText = w.filter(i => i.done).length;

            if(w.length===0) document.getElementById('noWishMsg').classList.remove('hidden');
            else {
                document.getElementById('noWishMsg').classList.add('hidden');
                w.forEach(wish=>{
                    const c = document.createElement('div');
                    c.className = `p-4 rounded-2xl border flex justify-between items-center transition ${wish.done?'bg-green-50 border-green-200 opacity-80':'bg-white border-pink-100 shadow-sm'}`;
                    
                    const cost = wish.cost ? new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(Number(wish.cost)) : 'Gratis';
                    
                    c.innerHTML = `
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 dark:text-white ${wish.done?'line-through text-gray-400':''}">${wish.name}</h4>
                            <div class="text-xs text-pink-500 font-bold mt-1">${cost}</div>
                            ${wish.link !== '#' ? `<a href="${wish.link}" target="_blank" class="text-[10px] text-blue-500 underline block mt-1">ğŸ”— Link</a>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleWish('${wish.id}',${wish.done})" class="px-3 py-2 rounded-lg text-xs font-bold ${wish.done?'bg-white text-green-500 border border-green-200':'bg-pink-500 text-white shadow'}">${wish.done?'Batal':'âœ…'}</button>
                            <button onclick="askDelete('wishlist/${wish.id}')" class="px-3 py-2 bg-gray-100 dark:bg-slate-700 text-gray-400 rounded-lg hover:text-red-500">ğŸ—‘ï¸</button>
                        </div>
                    `;
                    g.appendChild(c);
                });
            }
        });

        window.addWish = function() {
            const n = document.getElementById('wishName').value; if(!n) return showPopup('Hmm..','Nama barang?', 'error');
            const id = Date.now().toString();
            writeData(`wishlist/${id}`, { id, name: n, cost: document.getElementById('wishCost').value||0, link: document.getElementById('wishLink').value||'#', done: false, timestamp: Date.now() });
            document.getElementById('wishName').value=''; document.getElementById('wishCost').value=''; showPopup('Siap!', 'Masuk Bucket List!');
        }
        window.toggleWish = function(id, s) { set(ref(db, `wishlist/${id}/done`), !s); }

        // --- 10. VIDEO VAULT LOGIC & SHARE HANDLER ---
        listenToData('videos', (data) => {
            const g = document.getElementById('videoGrid');
            g.innerHTML = ''; const v = data ? Object.values(data).reverse() : [];
            if(v.length===0) document.getElementById('noVideoMsg').classList.remove('hidden'); else { document.getElementById('noVideoMsg').classList.add('hidden'); v.forEach(vid=>{
                const c = document.createElement('div');
                const fullUrl = vid.url || `https://www.youtube.com/watch?v=${vid.id}`;
                const ytId = (fullUrl.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/) && fullUrl.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/)[7].length==11) ? fullUrl.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/)[7] : false;
                const contentHTML = ytId ? `<div class="relative w-full aspect-video bg-black"><iframe class="absolute inset-0 w-full h-full" src="https://www.youtube-nocookie.com/embed/${ytId}?rel=0&modestbranding=1" frameborder="0" allowfullscreen></iframe></div>` : `<div class="relative w-full aspect-video bg-indigo-500 flex items-center justify-center text-white flex-col"><span class="text-3xl">ğŸ”—</span><span class="text-xs mt-2 uppercase font-bold">External Link</span></div>`;
                c.className = "bg-white dark:bg-slate-800 rounded-3xl shadow-lg overflow-hidden fade-in flex flex-col border border-gray-100 dark:border-slate-700 group h-full";
                c.innerHTML = `${contentHTML}<div class="p-5 flex justify-between items-center bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex-1"><div class="w-full"><h4 class="font-bold text-gray-800 dark:text-white text-sm line-clamp-2 mb-3" title="${vid.caption}">${vid.caption}</h4><div class="flex justify-between items-center"><a href="${fullUrl}" target="_blank" class="text-[10px] bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 px-3 py-1 rounded-full font-bold uppercase">Buka Link</a><button onclick="askDelete('videos/${vid.dbId}')" class="text-gray-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100">ğŸ—‘ï¸</button></div></div></div>`;
                g.appendChild(c);
            });}
        });

        window.addVideo = function() {
            const u = document.getElementById('videoUrl').value; if(!u||!u.includes('http')) return showPopup('Error','Link gak valid','error');
            const id = Date.now().toString();
            writeData(`videos/${id}`, { dbId: id, url: u, caption: document.getElementById('videoCaption').value||'Link' });
            document.getElementById('videoUrl').value=''; document.getElementById('videoCaption').value=''; showPopup('Mantap!','Link disimpan.');
        }

        // --- NEW: SHARE HANDLER (AUTO INPUT DARI TIKTOK/IG) ---
        window.handleSharedLink = function(text) {
            // Mencari URL dalam teks
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const found = text.match(urlRegex);
            if(found && found.length > 0) {
                const url = found[0];
                document.getElementById('videoUrl').value = url;
                // Scroll ke section video
                window.location.hash = '#videos';
                if(typeof Android !== 'undefined') Android.showToast("Link dari Share diterima! Klik Simpan.");
            }
        }

        // --- NEW: SHORTCUT HANDLER (WIDGET) ---
        // Cek URL Hash saat loading untuk shortcut (e.g., content://diary)
        window.onload = function() {
            if(window.location.hash === '#diary') {
                // Scroll ke diary atau buka form input
                document.getElementById('diaryTitle').focus();
            }
        }

    </script>
</body>
</html>